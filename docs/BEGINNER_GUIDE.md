# 🎓 ComfyUI-Custom-Batchbox 新手使用指南

欢迎使用 **ComfyUI-Custom-Batchbox**！本指南将帮助你从零开始配置并使用这套强大的 AI 生成节点系统。

---

## 📋 目录

1. [什么是 Batchbox？](#什么是-batchbox)
2. [快速开始（5分钟上手）](#快速开始5分钟上手)
3. [基础概念](#基础概念)
4. [图文教程](#图文教程)
5. [常见问题](#常见问题)

---

## 什么是 Batchbox？

Batchbox 是一套 ComfyUI 自定义节点，让你可以：

| 功能 | 说明 |
|------|------|
| 🎨 **多模型支持** | 一个节点支持多个 AI 模型（如 Gemini、GPT-4o 等） |
| 🔄 **动态参数** | 选择不同模型后，参数面板自动更新 |
| 🛡️ **自动故障转移** | API 请求失败时自动切换备用服务商 |
| ⚡ **并发生成** | 多个节点可同时生成，无需排队等待 |
| 💾 **自动保存** | 生成的图片自动保存到指定目录 |

---

## 快速开始（5分钟上手）

### 第 1 步：安装节点

1. 将本项目放入 ComfyUI 的 `custom_nodes` 目录：
   ```
   ComfyUI/custom_nodes/ComfyUI-Custom-Batchbox/
   ```

2. 安装依赖（在终端/命令行执行）：
   ```bash
   pip install pyyaml requests
   ```

3. **重启 ComfyUI**（必须重启才能加载节点）

### 第 2 步：配置 API 供应商

1. 在 ComfyUI 中，点击菜单栏找到 **"Batchbox API Manager"**

2. 添加供应商：
   - 点击 **"➕ 添加供应商"**
   - 填写供应商名称（如 `openai`）
   - 填写 Base URL（如 `https://api.openai.com`）
   - 填写 API Key

3. 点击 **"保存"**

### 第 3 步：配置模型

1. 在 API Manager 中切换到 **"模型"** 选项卡

2. 点击 **"➕ 添加模型"**

3. 填写模型信息：
   - **模型名称**：如 `gpt-4o`
   - **显示名称**：如 `🤖 GPT-4o`
   - **分类**：选择 `image`（图片）
   - **参数配置**：按需设置

4. 点击 **"保存"**

### 第 4 步：使用节点

1. 在画布空白处 **右键**
2. 选择你刚配置的模型节点
3. 在 **model** 下拉框选择模型
4. 填写 **prompt** 提示词
5. 点击节点上的 **"▶ 开始生成"** 按钮

🎉 **恭喜！你的第一张 AI 图片已生成！**

---

## 基础概念

### 📦 节点类型

Batchbox 提供以下节点类型：

| 节点 | 用途 | 输入 | 输出 |
|------|------|------|------|
| 🎨 图片生成 | 文生图、图生图 | 文本 / 图片 | 图片 |
| 📝 文本生成 | AI 脚本、广告词 | 文本 | 文本 |
| 🎬 视频生成 | AI 视频创作 | 文本 / 图片 | 视频 |
| 🎵 音频生成 | AI 音频合成 | 文本 | 音频 |
| 🔧 图片编辑 | 局部重绘、超分 | 图片 + 文本 | 图片 |

### 🏗️ 核心概念

#### 供应商（Provider）
API 服务的提供方，例如：
- OpenAI（官方接口）
- 第三方代理服务（如中转 API）

每个供应商需要配置：
- **Base URL**：API 地址
- **API Key**：访问密钥

#### 模型（Model）
具体的 AI 模型，例如：
- GPT-4o（图片生成）
- Gemini 2.0（多模态）
- 各种代理提供的模型

每个模型可以配置：
- **显示名称**：在节点中显示的名字
- **参数 Schema**：该模型支持的参数
- **API 端点**：调用的接口地址

#### 端点（Endpoint）
API 的调用配置，包括：
- **text2img**：文生图接口
- **img2img**：图生图接口（需要输入图片）

---

## 图文教程

### 教程 1：添加第一个节点

**方式一：右键快捷添加（推荐）**
1. 在画布空白处右键
2. 直接在菜单中选择 Batchbox 节点

**方式二：节点搜索**
1. 双击画布打开节点搜索
2. 搜索 `ComfyUI-Custom-Batchbox`
3. 选择对应类型的节点

### 教程 2：配置动态参数

1. 将节点添加到画布后，点击 **model** 下拉框
2. 选择你配置好的模型
3. 参数面板会 **自动更新**：
   - 基础参数（prompt、style 等）默认展开
   - 高级参数可点击展开

### 教程 3：执行生成

**方式一：节点按钮执行（推荐）**
- 点击节点上的 **"▶ 开始生成"** 按钮
- **只执行当前节点**，不影响其他工作流

**方式二：全局执行**
- 点击 ComfyUI 的 **Queue Prompt** 按钮
- 执行整个工作流

> 💡 **提示**：默认情况下，Batchbox 节点会被全局执行跳过，只能通过节点按钮触发。这可以在 API Manager 中关闭。

### 教程 4：配置自动保存

1. 打开 **Batchbox API Manager**
2. 切换到 **"保存设置"** 选项卡
3. 配置：
   - **启用自动保存**：开关
   - **保存目录**：默认 `output/batchbox/`
   - **命名格式**：如 `{model}_{timestamp}_{seed}`
   - **图片格式**：PNG/JPG/WebP

4. 点击 **"保存"**

---

## 常见问题

### ❓ 节点加载失败怎么办？

**检查依赖是否安装：**
```bash
pip install pyyaml requests
```

然后重启 ComfyUI。

### ❓ 提示 "API Key invalid" 怎么办？

1. 打开 API Manager
2. 检查供应商的 API Key 是否正确
3. 点击 👁 按钮可以显示/隐藏 Key 内容

### ❓ 生成失败自动切换供应商不生效？

确保：
1. 在模型配置中添加了多个端点（不同供应商）
2. 全局设置中 `auto_failover` 已开启

### ❓ 节点参数不更新怎么办？

1. 确认已保存配置（点击 API Manager 的保存按钮）
2. 配置支持热更新，无需刷新页面
3. 若仍有问题，按 `F5` 刷新页面

### ❓ 图片预览在重启后消失了？

- 启用 **自动保存** 功能后，预览图片会持久化
- 图片保存在 `output/batchbox/` 目录
- 重启后自动从保存的文件恢复预览

### ❓ 如何使用图生图（img2img）功能？

1. 在节点的 image 输入槽连接一张图片
2. 系统会自动切换到 img2img 模式
3. 填写修改提示词后执行

---

## 🎯 进阶技巧

### 批量生成
- 将 `batch_count` 参数设为大于 1 的值
- 系统会 **并行发送** 多个请求，大幅加速生成

### 多模型对比
- 添加多个 Batchbox 节点
- 选择不同模型
- 同时点击各节点的"开始生成"按钮
- 节点会 **并发执行**，无需等待

### 使用 Gemini API
1. 在端点配置中，将 **API 格式** 设为 `gemini`
2. 配置正确的 Gemini 端点路径
3. 启用 **Prompt 前缀**（如"生成一张图片："）确保返回图片

---

## 📚 更多资源

- [README.md](../README.md) - 项目概述
- [ARCHITECTURE.md](../ARCHITECTURE.md) - 架构设计
- [YAML_CONFIG_REFERENCE.md](../YAML_CONFIG_REFERENCE.md) - 配置参考

---

> 💬 遇到问题？欢迎在 GitHub 提 Issue！
