# ComfyUI-Custom-Batchbox äº§å“æ¶æ„ä¸éœ€æ±‚æ–‡æ¡£

## æ–‡æ¡£ç‰ˆæœ¬

| ç‰ˆæœ¬ | æ—¥æœŸ | æè¿° |
|------|------|------|
| 2.22 | 2026-01-30 | DOM Overlay UI å®éªŒæ€§åˆ†æ”¯ï¼ˆç°ä»£åŒ–å¡ç‰‡å¼ç•Œé¢ï¼‰ |
| 2.21 | 2026-01-29 | åŠ¨æ€ç¼“å­˜åŠ è½½ï¼ˆæ ¹æ®è¾“å‡ºç«¯å£è¿æ¥çŠ¶æ€æŒ‰éœ€åŠ è½½å›¾ç‰‡ï¼‰ |
| 2.20 | 2026-01-29 | å…±äº«å›¾ç‰‡æ•°æ®ä¼˜åŒ–ï¼ˆimg2img æ‰¹é‡å…±ç”¨ä¸€ä»½ base64ï¼‰+ multipart å…¼å®¹ä¿®å¤ |
| 2.19 | 2026-01-29 | ä¿®å¤è¯·æ±‚ä½“å¤§å°é™åˆ¶ï¼ˆåˆ†å—è¯»å–è§£å†³HTTPRequestEntityTooLargeï¼‰ |
| 2.18 | 2026-01-29 | æ‰¹é‡å›¾ç‰‡å°ºå¯¸å½’ä¸€åŒ–ï¼ˆå¼‚å°ºå¯¸ tensor å…¼å®¹ï¼‰ |
| 2.17 | 2026-01-28 | é€‰ä¸­å›¾ç‰‡æ”¾å¤§æ˜¾ç¤º + å¹¶å‘ç”Ÿæˆå´©æºƒä¿®å¤ |
| 2.16 | 2026-01-28 | æ™ºèƒ½ç¼“å­˜ï¼šèŠ‚ç‚¹ä½œä¸ºå›¾ç‰‡æ¥æº |
| 2.15 | 2026-01-27 | å³æ—¶ä¿å­˜ + Gemini imageConfig æ ¼å¼ä¿®å¤ |
| 2.14 | 2026-01-27 | åŠ¨æ€æ§½ä½ç´§å‡‘ + å¹¶è¡Œæ‰¹å¤„ç† + æ¨¡å‹è¿ç§» |
| 2.13 | 2026-01-27 | ç”»å¸ƒå³é”®èœå•å¿«æ·æ·»åŠ åŠŸèƒ½ |
| 2.12 | 2026-01-27 | åŠ¨æ€å‚æ•°æŒä¹…åŒ–ä¿®å¤ï¼ˆæ— é—ªçƒæ¢å¤æœºåˆ¶ï¼‰ |
| 2.11 | 2026-01-27 | é…ç½®çƒ­é‡è½½ + æ¨¡å‹ä¸‹æ‹‰åˆ—è¡¨å®æ—¶åˆ·æ–° |
| 2.10 | 2026-01-27 | "å¼€å§‹ç”Ÿæˆ"æŒ‰é’®æ‰©å±•è‡³æ‰€æœ‰èŠ‚ç‚¹ç±»å‹ |
| 2.9 | 2026-01-27 | ç‹¬ç«‹å¹¶å‘ç”Ÿæˆ + å›¾ç‰‡æ¢å¤ä¼˜åŒ– |
| 2.8 | 2026-01-26 | Queue Prompt æ‹¦æˆªå¼€å…³ |
| 2.7 | 2026-01-26 | "å¼€å§‹ç”Ÿæˆ"æŒ‰é’®éƒ¨åˆ†æ‰§è¡Œæ”¯æŒ |
| 2.6 | 2026-01-26 | Gemini åŸç”Ÿ API æ”¯æŒ + Prompt å‰ç¼€åŠŸèƒ½ |
| 2.5.1 | 2026-01-25 | èŠ‚ç‚¹å®½åº¦ç®¡ç†å™¨ï¼ˆAPI Manager å¯é…ç½®é»˜è®¤å®½åº¦ï¼‰ |
| 2.5 | 2026-01-25 | èŠ‚ç‚¹å®½åº¦ä¿æŒæœºåˆ¶ï¼ˆé˜²æ­¢ 252px é‡ç½®ï¼‰ |
| 2.4 | 2026-01-25 | èŠ‚ç‚¹ç”Ÿæˆå›¾ç‰‡é¢„è§ˆæŒä¹…åŒ– |
| 2.3 | 2026-01-25 | æ¨¡å‹æ’åºã€æ‹–æ‹½ UI |
| 2.2 | 2026-01-25 | è‡ªåŠ¨ä¿å­˜åŠŸèƒ½ |
| 2.1 | 2026-01-25 | é‡è¯•æœºåˆ¶ã€TTL ç¼“å­˜ã€æ—¥å¿—ç³»ç»Ÿ |
| 2.0 | 2026-01-24 | æ‰‹åŠ¨ç«¯ç‚¹é€‰æ‹©ã€è½®è¯¢æ¨¡å¼ã€å±‚çº§æ–‡ä»¶é…ç½® |
| 1.0 | 2026-01-24 | åˆç¨¿ |

### ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | è¯´æ˜ |
|------|------|
| [docs/hierarchical_config.md](docs/hierarchical_config.md) | å±‚çº§é…ç½®æŒ‡å—ï¼ˆProvider > Endpoint > Modeï¼‰ |
| [docs/comfyui_widget_serialization.md](docs/comfyui_widget_serialization.md) | ComfyUI Widget åºåˆ—åŒ–é¿å‘æŒ‡å— |
| [docs/preview_persistence.md](docs/preview_persistence.md) | é¢„è§ˆæŒä¹…åŒ–æœºåˆ¶ |
| [docs/node_width_retrospective.md](docs/node_width_retrospective.md) | èŠ‚ç‚¹å®½åº¦ä¿æŒå¼€å‘å¤ç›˜ |
| [YAML_CONFIG_REFERENCE.md](YAML_CONFIG_REFERENCE.md) | YAML é…ç½®å‚è€ƒï¼ˆä¾› LLM ä½¿ç”¨ï¼‰ |

---

## 1. é¡¹ç›®æ¦‚è¿°

ComfyUI-Custom-Batchbox æ˜¯ä¸€å¥— ComfyUI è‡ªå®šä¹‰èŠ‚ç‚¹ç³»ç»Ÿï¼Œå®ç°ï¼š

1. **åŠ¨æ€å‚æ•°é¢æ¿** - é€‰æ‹©æ¨¡å‹åè‡ªåŠ¨æ›´æ–°å‚æ•°æ§ä»¶
2. **å¤šç±»åˆ«èŠ‚ç‚¹** - å›¾ç‰‡/æ–‡æœ¬/è§†é¢‘/éŸ³é¢‘/ç¼–è¾‘å™¨
3. **å¤š API ä¸­è½¬ç«™** - åŒæ¨¡å‹æ”¯æŒå¤šä¸ª API ç«™ç‚¹
4. **æ™ºèƒ½ç«¯ç‚¹ç®¡ç†** - è½®è¯¢ã€æ‰‹åŠ¨é€‰æ‹©ã€æ•…éšœè½¬ç§»
5. **çµæ´»é…ç½®** - YAML é…ç½® + å¯è§†åŒ–ç®¡ç†å™¨

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    subgraph ComfyUIå‰ç«¯
        A[èŠ‚ç‚¹UI] --> B[åŠ¨æ€å‚æ•°æ¸²æŸ“å™¨]
        B --> C[å‚æ•°Schemaè§£æå™¨]
        D[API Manager UI] --> E[é…ç½®ç¼–è¾‘]
    end
    
    subgraph è‡ªå®šä¹‰èŠ‚ç‚¹åç«¯
        F[DynamicImageNodeBase] --> F1[NanoBananaPro]
        F --> G[DynamicImageGeneration]
        F --> H[DynamicTextGeneration]
        F --> I[DynamicVideoGeneration]
        F --> J[DynamicAudioGeneration]
        F --> K[DynamicImageEditor]
    end
    
    subgraph é…ç½®ç®¡ç†å±‚
        K[ConfigManager] --> L[api_config.yaml]
        K --> M[ä¾›åº”å•†é…ç½®]
        K --> N[æ¨¡å‹Schema]
    end
    
    subgraph APIé€‚é…å™¨å±‚
        O[GenericAdapter] --> P[å±‚çº§é…ç½®]
        O --> Q{api_format?}
        Q -->|openai| Q1[OpenAIè¯·æ±‚æ„å»º]
        Q -->|gemini| Q2[Geminiè¯·æ±‚æ„å»º]
        Q1 --> R[å“åº”è§£æ]
        Q2 --> R2[Geminiå“åº”è§£æ]
    end
    
    subgraph Promptå¤„ç†
        PP[prompt_prefix] --> PPM[å‰ç¼€åˆå¹¶]
        PPM --> Q
    end
    
    A <--> F
    F <--> K
    F <--> O
    O --> S[å¤–éƒ¨APIæœåŠ¡]
    D --> K
```

### 2.2 åŠ¨æ€å‚æ•°æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant UI as ComfyUIå‰ç«¯
    participant JS as dynamic_params.js
    participant API as /api/batchbox/schema
    participant Config as ConfigManager
    
    User->>UI: é€‰æ‹©æ¨¡å‹ä¸‹æ‹‰æ¡†
    UI->>JS: è§¦å‘ onchange
    JS->>API: GET /api/batchbox/schema/{model}
    API->>Config: è·å–å‚æ•°Schema
    Config-->>API: è¿”å›å‚æ•°å®šä¹‰
    API-->>JS: è¿”å›JSON Schema
    JS->>UI: åŠ¨æ€æ¸²æŸ“å‚æ•°æ§ä»¶
    UI-->>User: æ˜¾ç¤ºæ–°å‚æ•°é¢æ¿
```

### 2.3 ç«¯ç‚¹é€‰æ‹©ä¸è½®è¯¢

```mermaid
flowchart TD
    A[å¼€å§‹è¯·æ±‚] --> B{æ‰‹åŠ¨é€‰æ‹©?}
    B -->|æ˜¯| C[ä½¿ç”¨æŒ‡å®šç«¯ç‚¹]
    B -->|å¦| D[è½®è¯¢é€‰æ‹©ç«¯ç‚¹]
    D --> E[endpoint_index++ % ç«¯ç‚¹æ•°]
    C --> F[æ„å»ºè¯·æ±‚]
    E --> F
    F --> G{è¯·æ±‚æˆåŠŸ?}
    G -->|æ˜¯| H[è¿”å›ç»“æœ]
    G -->|å¦| I{æ‰‹åŠ¨æ¨¡å¼?}
    I -->|æ˜¯| J[è¿”å›é”™è¯¯]
    I -->|å¦| K{æœ‰å¤‡ç”¨ç«¯ç‚¹?}
    K -->|æ˜¯| L[åˆ‡æ¢ä¸‹ä¸€ä¸ª]
    L --> F
    K -->|å¦| J
```

### 2.4 å±‚çº§é…ç½®ä¼˜å…ˆçº§

```mermaid
flowchart LR
    A[è¯»å–file_format] --> B{ç«¯ç‚¹çº§é…ç½®?}
    B -->|æœ‰| C[ä½¿ç”¨ç«¯ç‚¹é…ç½®]
    B -->|æ— | D{ä¾›åº”å•†çº§é…ç½®?}
    D -->|æœ‰| E[ä½¿ç”¨ä¾›åº”å•†é…ç½®]
    D -->|æ— | F[ä½¿ç”¨ç³»ç»Ÿé»˜è®¤ same_name]
```

---

## 2.5 èŠ‚ç‚¹ç±»å‹

| èŠ‚ç‚¹ ID | æ˜¾ç¤ºåç§° | ç”¨é€” |
|---------|----------|------|
| `NanoBananaPro` | ğŸŒ Nano Banana Pro (Universal) | é€šç”¨å›¾åƒèŠ‚ç‚¹ |
| `DynamicImageGeneration` | ğŸ¨ Dynamic Image Generation | åŠ¨æ€å›¾åƒç”Ÿæˆ |
| `DynamicTextGeneration` | ğŸ“ Dynamic Text Generation | åŠ¨æ€æ–‡æœ¬ç”Ÿæˆ |
| `DynamicVideoGeneration` | ğŸ¬ Dynamic Video Generation | åŠ¨æ€è§†é¢‘ç”Ÿæˆ |
| `DynamicAudioGeneration` | ğŸµ Dynamic Audio Generation (Beta) | åŠ¨æ€éŸ³é¢‘ç”Ÿæˆ |
| `DynamicImageEditor` | ğŸ”§ Dynamic Image Editor | å›¾åƒç¼–è¾‘å™¨ |

---

## 3. æ ¸å¿ƒåŠŸèƒ½

### 3.1 åŠ¨æ€å‚æ•°ç³»ç»Ÿ

**æµç¨‹ï¼š**
```
ç”¨æˆ·é€‰æ‹©æ¨¡å‹ â†’ JS è¯·æ±‚ /api/batchbox/schema/{model} 
            â†’ åç«¯è¿”å›å‚æ•° Schema 
            â†’ å‰ç«¯åŠ¨æ€æ¸²æŸ“æ§ä»¶
```

**å‚æ•°ç±»å‹æ”¯æŒï¼š**
- `string` - æ–‡æœ¬è¾“å…¥
- `select` - ä¸‹æ‹‰é€‰æ‹©
- `number` - æ•°å­—æ»‘å—
- `boolean` - å¼€å…³

### 3.2 ç«¯ç‚¹ç®¡ç†

**æ¨¡å¼ï¼š**
| æ¨¡å¼ | æè¿° |
|------|------|
| è‡ªåŠ¨è½®è¯¢ | æŒ‰é¡ºåºè½®æµä½¿ç”¨å„ç«¯ç‚¹ |
| æ‰‹åŠ¨é€‰æ‹© | ç”¨æˆ·æŒ‡å®šç‰¹å®šç«¯ç‚¹ |
| æ•…éšœè½¬ç§» | å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢ä¸‹ä¸€ä¸ª |

**é…ç½®ä¼˜å…ˆçº§ï¼š**
```
ç«¯ç‚¹çº§ > ä¾›åº”å•†çº§ > ç³»ç»Ÿé»˜è®¤
```

### 3.3 æ–‡ä»¶æ ¼å¼é…ç½®

**æ”¯æŒæ ¼å¼ï¼š**
| æ ¼å¼ | ç¤ºä¾‹ | é€‚ç”¨ API |
|------|------|----------|
| `same_name` | `image, image` | OpenAI (é»˜è®¤) |
| `indexed` | `image[0], image[1]` | PHP |
| `array` | `images[]` | Rails |
| `numbered` | `image1, image2` | ä¼ ç»Ÿ |

### 3.4 åŠ¨æ€è¾“å…¥æ§½

**åŠŸèƒ½ï¼š** è¿æ¥å›¾ç‰‡åè‡ªåŠ¨æ·»åŠ ä¸‹ä¸€ä¸ªè¾“å…¥æ§½

**é…ç½®ï¼š**
```yaml
dynamic_inputs:
  image:
    max: 14
    type: IMAGE
```

### 3.5 å¤š API æ ¼å¼æ”¯æŒ

**æ”¯æŒçš„ API æ ¼å¼ï¼š**

| æ ¼å¼ | ç«¯ç‚¹ç¤ºä¾‹ | ç‰¹ç‚¹ |
|------|----------|------|
| `openai` | `/v1/chat/completions` | æ ‡å‡† OpenAI å…¼å®¹æ ¼å¼ï¼ˆé»˜è®¤ï¼‰ |
| `gemini` | `/v1beta/models/{model}:generateContent` | Gemini åŸç”Ÿæ ¼å¼ï¼Œæ”¯æŒ `responseModalities` |

**Gemini æ ¼å¼è¯·æ±‚æ„å»ºæµç¨‹ï¼š**

```mermaid
flowchart TD
    A[build_request å…¥å£] --> B{api_format?}
    B -->|openai| C[_build_openai_request]
    B -->|gemini| D[_build_gemini_request]
    D --> E[æ„å»º contents æ•°ç»„]
    E --> F[æ·»åŠ  text part]
    E --> G[æ·»åŠ  inline_data å›¾ç‰‡]
    D --> H[æ„å»º generationConfig]
    H --> I[æ·»åŠ  responseModalities]
    H --> J[æ·»åŠ  seed/maxTokens]
    C --> K[å‘é€è¯·æ±‚]
    D --> K
```

**Gemini å“åº”è§£æï¼š**

```mermaid
flowchart TD
    A[parse_response] --> B{æ£€æµ‹å“åº”æ ¼å¼}
    B -->|candidates å­˜åœ¨| C[_parse_gemini_response]
    B -->|å¦åˆ™| D[OpenAI æ ¼å¼è§£æ]
    C --> E[æå– candidates[0].content.parts]
    E --> F{part ç±»å‹?}
    F -->|inlineData| G[base64 è§£ç ä¸ºå›¾ç‰‡]
    F -->|fileData| H[æå– fileUri URL]
    G --> I[è¿”å› APIResponse]
    H --> I
```

### 3.6 Prompt å‰ç¼€

**åŠŸèƒ½ï¼š** è‡ªåŠ¨åœ¨ç”¨æˆ· prompt å‰æ·»åŠ é…ç½®çš„å‰ç¼€æ–‡æœ¬

**ç”¨é€”ï¼š** å¼ºåˆ¶æ¨¡å‹ç”Ÿæˆå›¾ç‰‡è€Œéæ–‡æœ¬å›å¤ï¼ˆå¦‚ Gemini å¤šæ¨¡æ€æ¨¡å‹ï¼‰

**é…ç½®ï¼š**
```yaml
api_endpoints:
  - display_name: Geminiå›¾ç‰‡
    prompt_prefix: "ç”Ÿæˆä¸€å¼ å›¾ç‰‡ï¼š"
    api_format: gemini
```

**å¤„ç†æµç¨‹ï¼š**
```
ç”¨æˆ·è¾“å…¥: "å“ˆå“ˆå“ˆ"
     â†“
prompt_prefix: "ç”Ÿæˆä¸€å¼ å›¾ç‰‡ï¼š"
     â†“
å®é™…å‘é€: "ç”Ÿæˆä¸€å¼ å›¾ç‰‡ï¼šå“ˆå“ˆå“ˆ"
```

---

## 4. é…ç½®ç³»ç»Ÿ

### 4.1 YAML ç»“æ„

```yaml
# ä¾›åº”å•†
providers:
  openai_compatible:
    base_url: https://api.example.com
    api_key: sk-xxx
    file_format: same_name  # ä¾›åº”å•†çº§é»˜è®¤

# æ¨¡å‹
models:
  ModelName:
    display_name: ğŸ¨ æ˜¾ç¤ºå
    category: image
    dynamic_inputs: {...}
    parameter_schema:
      basic: {...}
      advanced: {...}
    api_endpoints:
      - provider: openai_compatible
        priority: 1
        modes:
          text2img:
            endpoint: /v1/images/generations
            response_path: data[0].url
          img2img:
            endpoint: /v1/images/edits
            file_format: indexed  # ç«¯ç‚¹çº§è¦†ç›–
```

### 4.2 å¯è§†åŒ–ç®¡ç†å™¨

**åŠŸèƒ½ï¼š**
- ä¾›åº”å•† CRUDï¼ˆåŒ…å«é«˜çº§æ–‡ä»¶æ ¼å¼è®¾ç½®ï¼‰
- æ¨¡å‹é…ç½®ï¼ˆå‚æ•°ã€ç«¯ç‚¹ï¼‰
- ç«¯ç‚¹é«˜çº§è®¾ç½®ï¼ˆæŠ˜å å¼ï¼‰

---

## 5. æ–‡ä»¶ç»“æ„

```
ComfyUI-Custom-Batchbox/
â”œâ”€â”€ __init__.py              èŠ‚ç‚¹æ³¨å†Œ + API è·¯ç”±
â”œâ”€â”€ nodes.py                 èŠ‚ç‚¹ç±»å®šä¹‰
â”œâ”€â”€ config_manager.py        é…ç½®ç®¡ç†ï¼ˆå«ç¼“å­˜ã€éªŒè¯ï¼‰
â”œâ”€â”€ batchbox_logger.py       æ—¥å¿—ä¸é‡è¯•æ¨¡å—
â”œâ”€â”€ errors.py                ç»“æ„åŒ–å¼‚å¸¸ç±»
â”œâ”€â”€ image_utils.py           å›¾ç‰‡å¤„ç†å·¥å…·
â”œâ”€â”€ api_config.yaml          ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ README.md                é¡¹ç›®è¯´æ˜
â”œâ”€â”€ ARCHITECTURE.md          æ¶æ„æ–‡æ¡£ï¼ˆæœ¬æ–‡ï¼‰
â”œâ”€â”€ YAML_CONFIG_REFERENCE.md LLM é…ç½®å‚è€ƒ
â”œâ”€â”€ adapters/
â”‚   â”œâ”€â”€ __init__.py          é€‚é…å™¨å¯¼å‡º
â”‚   â”œâ”€â”€ base.py              é€‚é…å™¨æ¥å£
â”‚   â”œâ”€â”€ generic.py           é€šç”¨é€‚é…å™¨ï¼ˆå±‚çº§é…ç½® + é‡è¯•ï¼‰
â”‚   â””â”€â”€ template_engine.py   è¯·æ±‚æ¨¡æ¿å¼•æ“
â”œâ”€â”€ web/                       å‰ç«¯æ¨¡å—
â”‚   â”œâ”€â”€ api_manager.js         APIç®¡ç†ç•Œé¢
â”‚   â”œâ”€â”€ api_manager.css        ç®¡ç†ç•Œé¢æ ·å¼
â”‚   â”œâ”€â”€ dynamic_params.js      åŠ¨æ€å‚æ•°æ¸²æŸ“
â”‚   â”œâ”€â”€ dynamic_params.css
â”‚   â””â”€â”€ dynamic_inputs.js      åŠ¨æ€è¾“å…¥æ§½
â”œâ”€â”€ save_settings.py           è‡ªåŠ¨ä¿å­˜æ¨¡å—
â””â”€â”€ tests/                     å•å…ƒæµ‹è¯•
    â”œâ”€â”€ test_errors.py       å¼‚å¸¸ç±»æµ‹è¯•
    â””â”€â”€ test_adapters.py     é€‚é…å™¨æµ‹è¯•
```

---

## 6. API æ¥å£

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° |
|------|------|------|
| `/api/batchbox/config` | GET | è·å–å®Œæ•´é…ç½® |
| `/api/batchbox/config` | POST | ä¿å­˜å®Œæ•´é…ç½® |
| `/api/batchbox/models` | GET | è·å–æ‰€æœ‰æ¨¡å‹åˆ—è¡¨ |
| `/api/batchbox/schema/{model}` | GET | è·å–æ¨¡å‹å‚æ•° Schema |
| `/api/batchbox/providers` | GET | è·å–ä¾›åº”å•†åˆ—è¡¨ |
| `/api/batchbox/providers/{name}` | PUT | æ›´æ–°ä¾›åº”å•†é…ç½® |
| `/api/batchbox/categories` | GET | è·å–èŠ‚ç‚¹åˆ†ç±» |
| `/api/batchbox/save-settings` | GET | è·å–è‡ªåŠ¨ä¿å­˜é…ç½® |
| `/api/batchbox/save-settings` | POST | æ›´æ–°è‡ªåŠ¨ä¿å­˜é…ç½® |
| `/api/batchbox/save-settings/preview` | POST | é¢„è§ˆæ–‡ä»¶å |
| `/api/batchbox/model-order/{category}` | GET | è·å–æ¨¡å‹æ’åº |
| `/api/batchbox/model-order/{category}` | POST | æ›´æ–°æ¨¡å‹æ’åº |
| `/api/batchbox/node-settings` | GET | è·å–èŠ‚ç‚¹æ˜¾ç¤ºè®¾ç½® |
| `/api/batchbox/node-settings` | POST | æ›´æ–°èŠ‚ç‚¹æ˜¾ç¤ºè®¾ç½® |

---

## 7. æŠ€æœ¯è¦ç‚¹

### 7.1 èŠ‚ç‚¹ç±»å‹è¯†åˆ«
```javascript
// ComfyUI ä¸­éœ€è¦ç”¨ comfyClass è€Œä¸æ˜¯ type
const nodeType = node.comfyClass || node.type;
```

### 7.2 å‚æ•°ä¼ é€’
```javascript
// æ‹¦æˆª queuePrompt åœ¨æ‰§è¡Œå‰æ”¶é›†å‚æ•°
api.queuePrompt = async function(...) {
  // æ›´æ–° extra_params widget
  return origQueuePrompt.call(this, ...);
};
```

### 7.3 å±‚çº§é…ç½®è¯»å–
```python
file_format = (
    mode_config.get("file_format") or
    endpoint.get("file_format") or
    provider.get("file_format") or
    "same_name"
)
```

### 7.4 è‡ªåŠ¨ä¿å­˜åŠŸèƒ½

ç”Ÿæˆçš„å›¾ç‰‡ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æŒ‡å®šç›®å½•ï¼Œé€šè¿‡ `save_settings.py` æ¨¡å—å®ç°ã€‚

**é…ç½®é¡¹ï¼š**

| è®¾ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `enabled` | bool | true | å¯ç”¨/ç¦ç”¨è‡ªåŠ¨ä¿å­˜ |
| `output_dir` | string | "batchbox" | ä¿å­˜ç›®å½•ï¼ˆç›¸å¯¹äº output/ï¼‰ |
| `format` | string | "original" | æ–‡ä»¶æ ¼å¼ï¼šoriginal/png/jpg/webp |
| `fallback_format` | string | "png" | ä¿æŒåŸæ ¼å¼æ—¶çš„é»˜è®¤æ ¼å¼ |
| `quality` | int | 95 | JPG/WebP è´¨é‡ (1-100) |
| `naming_pattern` | string | "{model}_{timestamp}_{seed}" | å‘½åæ¨¡æ¿ |
| `create_date_subfolder` | bool | true | æŒ‰æ—¥æœŸåˆ›å»ºå­æ–‡ä»¶å¤¹ |

**å‘½åæ¨¡æ¿å˜é‡ï¼š**

| å˜é‡ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `{model}` | æ¨¡å‹åç§° | nano_banana_pro |
| `{timestamp}` | å®Œæ•´æ—¶é—´æˆ³ | 20260125_093421 |
| `{date}` | æ—¥æœŸ | 2026-01-25 |
| `{time}` | æ—¶é—´ | 09-34-21 |
| `{seed}` | éšæœºç§å­ | 1234567890 |
| `{batch}` | æ‰¹æ¬¡åºå· | 1 |
| `{uuid}` | 8ä½å”¯ä¸€ID | a1b2c3d4 |
| `{prompt}` | æç¤ºè¯ï¼ˆéœ€å¯ç”¨ï¼‰ | beautiful_sunset |

**ä¿å­˜æµç¨‹ï¼š**

```mermaid
flowchart LR
    A[ç”Ÿæˆå®Œæˆ] --> B{è‡ªåŠ¨ä¿å­˜å¯ç”¨?}
    B -->|æ˜¯| C[ç”Ÿæˆæ–‡ä»¶å]
    B -->|å¦| D[è·³è¿‡]
    C --> E{æ—¥æœŸå­æ–‡ä»¶å¤¹?}
    E -->|æ˜¯| F[åˆ›å»ºæ—¥æœŸç›®å½•]
    E -->|å¦| G[ä½¿ç”¨ä¸»ç›®å½•]
    F --> H[ä¿å­˜å›¾ç‰‡]
    G --> H
```

### 7.5 æ¨¡å‹æ’åºåŠŸèƒ½

é€šè¿‡ `model_order` é…ç½®æ§åˆ¶æ¨¡å‹åœ¨ API Manager å’ŒèŠ‚ç‚¹ä¸‹æ‹‰æ¡†ä¸­çš„æ˜¾ç¤ºé¡ºåºã€‚

**é…ç½®æ ¼å¼ï¼š**

```yaml
model_order:
  image:
    - Nano Banana Pro   # ç¬¬1ä¸ª
    - tapnow_flash      # ç¬¬2ä¸ª
    - grok2_image       # ç¬¬3ä¸ª
  text: []
  video: []
```

**å®¹é”™æœºåˆ¶ï¼š**

| æƒ…å†µ | å¤„ç†æ–¹å¼ |
|------|----------|
| å¿˜è®°é…ç½® `model_order` | ä½¿ç”¨é»˜è®¤é¡ºåºï¼ˆå­—æ¯æ’åºï¼‰ |
| åˆ—è¡¨æœ‰é‡å¤æ¨¡å‹å | ä»…ä¿ç•™é¦–æ¬¡å‡ºç°çš„ä½ç½® |
| æ¨¡å‹å·²åˆ é™¤ä½†æ®‹ç•™åœ¨åˆ—è¡¨ | è‡ªåŠ¨è¿‡æ»¤ä¸å­˜åœ¨çš„æ¨¡å‹ |
| æ–°å¢æ¨¡å‹æœªåœ¨åˆ—è¡¨ä¸­ | è‡ªåŠ¨è¿½åŠ åˆ°æœ«å°¾ |

**å‰ç«¯æ‹–æ‹½å®ç°ï¼š**

- ä½¿ç”¨ HTML5 Drag & Drop API
- æ‹–æ‹½æ‰‹æŸ„ï¼š`â‹®â‹®` ç¬¦å·
- è§†è§‰åé¦ˆï¼šæ‹–æ‹½æ—¶è¡ŒåŠé€æ˜ï¼Œç›®æ ‡ä½ç½®é‡‘è‰²è¾¹æ¡†
- é‡Šæ”¾åè‡ªåŠ¨ä¿å­˜åˆ°åç«¯

**æ’åºé€»è¾‘ï¼ˆPythonï¼‰ï¼š**

```python
def _sort_models_by_order(self, model_names, category):
    order = self.get_model_order(category)
    order_map = {name: i for i, name in enumerate(order)}
    max_index = len(order)
    # å·²é…ç½®çš„æŒ‰é¡ºåºæ’ï¼Œæœªé…ç½®çš„æŒ‰å­—æ¯è¿½åŠ åˆ°æœ«å°¾
    return sorted(model_names, key=lambda x: (order_map.get(x, max_index), x))
```

### 7.6 èŠ‚ç‚¹å®½åº¦ä¿æŒæœºåˆ¶

é˜²æ­¢èŠ‚ç‚¹å®½åº¦åœ¨åŠ¨æ€æ›´æ–°æ—¶è¢«é‡ç½®ä¸º ~252pxï¼ˆLiteGraph é»˜è®¤è®¡ç®—å®½åº¦ï¼‰ã€‚**v2.5.1 æ–°å¢"èŠ‚ç‚¹å®½åº¦ç®¡ç†å™¨"**ï¼Œç”¨æˆ·å¯åœ¨ API Manager â†’ ä¿å­˜è®¾ç½® Tab ä¸­é…ç½®æ–°å»ºèŠ‚ç‚¹çš„é»˜è®¤å®½åº¦ï¼ˆ300-1200pxï¼‰ã€‚

**é—®é¢˜æµç¨‹ï¼š**

```mermaid
flowchart LR
    A[ç”¨æˆ·è°ƒæ•´èŠ‚ç‚¹å®½åº¦] --> B[åˆ‡æ¢æ¨¡å‹/é¢„è®¾]
    B --> C[updateWidgets è¢«è°ƒç”¨]
    C --> D[setSize\computeSize\]
    D --> E[å®½åº¦é‡ç½®ä¸º 252px âŒ]
```

**è§£å†³æ–¹æ¡ˆæµç¨‹ï¼š**

```mermaid
flowchart LR
    A[ç”¨æˆ·è°ƒæ•´èŠ‚ç‚¹å®½åº¦] --> B[åˆ‡æ¢æ¨¡å‹/é¢„è®¾]
    B --> C[updateWidgets è¢«è°ƒç”¨]
    C --> D[resizeNodePreservingWidth]
    D --> E[ä¿å­˜å½“å‰å®½åº¦]
    E --> F[åªæ›´æ–°é«˜åº¦]
    F --> G[å®½åº¦ä¿æŒä¸å˜ âœ“]
```

**æ ¸å¿ƒå®ç°ï¼š**

```javascript
// è¾…åŠ©å‡½æ•°ï¼šä¿æŒå®½åº¦åªæ›´æ–°é«˜åº¦
function resizeNodePreservingWidth(node) {
  const currentWidth = node.size[0];
  const computedSize = node.computeSize();
  node.setSize([currentWidth, computedSize[1]]);
}
```

**ç”Ÿå‘½å‘¨æœŸåŒºåˆ†ï¼š**

```mermaid
flowchart TD
    A[èŠ‚ç‚¹åˆ›å»º] --> B{nodeCreated}
    B --> C[è®¾ç½® _fresh_create = true]
    C --> D{50ms åæ£€æŸ¥}
    D --> E{_fresh_create?}
    E -->|æ˜¯| F1[æ–°å»ºèŠ‚ç‚¹: è·å–é…ç½®å®½åº¦]
    F1 --> F2[getNodeSettings]
    F2 --> F3[ä½¿ç”¨ default_width]
    E -->|å¦| G[åŠ è½½èŠ‚ç‚¹: ä½¿ç”¨ä¿å­˜çš„å®½åº¦]
    
    H[å·¥ä½œæµåŠ è½½] --> I{loadedGraphNode}
    I --> J[è®¾ç½® _fresh_create = false]
    J --> K[ä¿å­˜ savedWidth]
    K --> L[åˆå§‹åŒ–åæ¢å¤ savedWidth]
```

**å¯é…ç½®é»˜è®¤å®½åº¦ï¼ˆv2.5.1ï¼‰ï¼š**

```javascript
// ä»åç«¯è·å–èŠ‚ç‚¹è®¾ç½®
async function getNodeSettings() {
    const resp = await api.fetchApi("/api/batchbox/node-settings");
    const data = await resp.json();
    return data.node_settings || { default_width: 500 };
}

// åœ¨ nodeCreated ä¸­ä½¿ç”¨
const nodeSettings = await getNodeSettings();
const defaultWidth = nodeSettings.default_width || 500;
node.size = [defaultWidth, computedSize[1]];
```

**é…ç½®å­˜å‚¨ (api_config.yaml)ï¼š**

```yaml
node_settings:
  default_width: 500  # èŒƒå›´: 300-1200px
```

**ä¿®æ”¹çš„å‡½æ•°ï¼š**

| æ–‡ä»¶ | å‡½æ•° | ä¿®æ”¹ |
|------|------|------|
| `dynamic_inputs.js` | `addDynamicInput` | ä¿å­˜/æ¢å¤å®½åº¦ |
| `dynamic_inputs.js` | `removeDynamicInput` | ä¿å­˜/æ¢å¤å®½åº¦ |
| `dynamic_inputs.js` | `updateInputsForType` | ä¿å­˜/æ¢å¤å®½åº¦ |
| `dynamic_inputs.js` | `getNodeSettings` | æ–°å¢: ä»åç«¯è·å–é…ç½® |
| `dynamic_inputs.js` | `nodeCreated` | ä½¿ç”¨é…ç½®çš„é»˜è®¤å®½åº¦ |
| `dynamic_params.js` | `resizeNodePreservingWidth` | æ–°å¢è¾…åŠ©å‡½æ•° |
| `dynamic_params.js` | 7 å¤„ `setSize` è°ƒç”¨ | æ›¿æ¢ä¸ºè¾…åŠ©å‡½æ•° |
| `config_manager.py` | `get_node_settings` | æ–°å¢: è·å–èŠ‚ç‚¹è®¾ç½® |
| `config_manager.py` | `update_node_settings` | æ–°å¢: æ›´æ–°èŠ‚ç‚¹è®¾ç½® |
| `api_manager.js` | `renderSaveSettings` | æ·»åŠ å®½åº¦æ»‘å— UI |

### 7.7 éƒ¨åˆ†æ‰§è¡Œæœºåˆ¶

**åŠŸèƒ½ï¼š** ç‚¹å‡»"â–¶ å¼€å§‹ç”Ÿæˆ"æŒ‰é’®æ—¶ï¼Œåªæ‰§è¡Œç›®æ ‡èŠ‚ç‚¹åŠå…¶ä¸Šæ¸¸ä¾èµ–ï¼Œä¸æ‰§è¡Œå·¥ä½œæµä¸­ä¸ç›¸å…³çš„åˆ†æ”¯ã€‚

**æ ¸å¿ƒåŸç†ï¼š**

ComfyUI æ‰§è¡Œå·¥ä½œæµæ—¶ï¼Œä¼šå°†æ•´ä¸ª graph åºåˆ—åŒ–ä¸º `prompt.output` å¯¹è±¡å‘é€ç»™åç«¯ã€‚éƒ¨åˆ†æ‰§è¡Œçš„å®ç°æ˜¯åœ¨å‘é€å‰è¿‡æ»¤ `prompt.output`ï¼Œåªä¿ç•™éœ€è¦æ‰§è¡Œçš„èŠ‚ç‚¹ã€‚

**å®ç°æµç¨‹ï¼š**

```mermaid
flowchart TD
    A[ç‚¹å‡»å¼€å§‹ç”ŸæˆæŒ‰é’®] --> B[executeToNode]
    B --> C[ä¸´æ—¶è¦†ç›– api.queuePrompt]
    C --> D[app.queuePrompt åºåˆ—åŒ–å·¥ä½œæµ]
    D --> E[æ‹¦æˆª prompt.output]
    E --> F[recursiveAddNodes æ”¶é›†ä¸Šæ¸¸ä¾èµ–]
    F --> G[è¿‡æ»¤ prompt.output]
    G --> H[è°ƒç”¨åŸå§‹ queuePrompt]
    H --> I[ç«‹å³æ¢å¤åŸå§‹æ–¹æ³•]
```

**æ ¸å¿ƒå‡½æ•°ï¼š**

| å‡½æ•° | ä½œç”¨ |
|------|------|
| `recursiveAddNodes(nodeId, oldOutput, newOutput)` | é€’å½’æ”¶é›†èŠ‚ç‚¹åŠå…¶ä¸Šæ¸¸ä¾èµ– |
| `executeToNode(node)` | ä¸´æ—¶è¦†ç›– `api.queuePrompt` å®ç°éƒ¨åˆ†æ‰§è¡Œ |

**prompt.output ç»“æ„ç¤ºä¾‹ï¼š**

```javascript
{
  "3": { "class_type": "KSampler", "inputs": {...} },      // ä¸Šæ¸¸èŠ‚ç‚¹
  "4": { "class_type": "VAEDecode", "inputs": {"samples": ["3", 0]} },  // ä¾èµ–èŠ‚ç‚¹3
  "5": { "class_type": "SaveImage", "inputs": {"images": ["4", 0]} },   // ç›®æ ‡èŠ‚ç‚¹
  "8": { "class_type": "LoadImage", "inputs": {...} },    // ç‹¬ç«‹åˆ†æ”¯ï¼ˆè¢«è¿‡æ»¤ï¼‰
  "9": { "class_type": "PreviewImage", "inputs": {...} }  // ç‹¬ç«‹åˆ†æ”¯ï¼ˆè¢«è¿‡æ»¤ï¼‰
}
```

**å®˜æ–¹ API çŠ¶æ€ï¼š**

| åŠŸèƒ½ | å®˜æ–¹ API | å®ç°æ–¹å¼ |
|------|----------|----------|
| å³é”®èœå• | `getNodeMenuItems()` | âœ… æ¨è |
| é€‰æ‹©å·¥å…·æ  | `getSelectionToolboxCommands()` | âœ… æ¨è |
| ä¿®æ”¹ prompt | æ— å®˜æ–¹ API | âš ï¸ ä¸´æ—¶ monkey-patch |

> **æ³¨æ„ï¼š** å®˜æ–¹æ˜ç¡®è­¦å‘Š monkey-patching æ˜¯ deprecatedï¼Œä½†ç›®å‰æ²¡æœ‰æ›¿ä»£æ–¹æ¡ˆã€‚å®ç°é‡‡ç”¨ä¸´æ—¶è¦†ç›–ï¼ˆæ‰§è¡Œåç«‹å³æ¢å¤ï¼‰ä»¥æœ€å°åŒ–å½±å“ã€‚

### 7.8 Queue Prompt æ‹¦æˆªæœºåˆ¶

**åŠŸèƒ½ï¼š** å…¨å±€ Queue Prompt æ—¶è‡ªåŠ¨æ’é™¤ BatchBox èŠ‚ç‚¹ï¼Œä»…å…è®¸é€šè¿‡èŠ‚ç‚¹ä¸Šçš„"å¼€å§‹ç”Ÿæˆ"æŒ‰é’®è§¦å‘æ‰§è¡Œã€‚

**åº”ç”¨åœºæ™¯ï¼š**
- ComfyUI é‡å¯åç”¨æˆ·æŒ‰ Queue Prompt æ—¶ï¼Œé¿å…é‡æ–°æ‰§è¡Œæ‰€æœ‰ API è°ƒç”¨èŠ‚ç‚¹
- å·¥ä½œæµä¸­æœ‰å¤šä¸ªç‹¬ç«‹çš„ BatchBox èŠ‚ç‚¹æ—¶ï¼Œé¿å…åŒæ—¶è§¦å‘

**å®ç°æµç¨‹ï¼š**

```mermaid
flowchart TD
    A[ç”¨æˆ·æ“ä½œ] --> B{è§¦å‘æ¥æº?}
    B -->|èŠ‚ç‚¹æŒ‰é’®| C[è®¾ç½® isButtonTriggered = true]
    B -->|å…¨å±€ Queue Prompt| D[isButtonTriggered = false]
    C --> E[api.queuePrompt æ‹¦æˆªå™¨]
    D --> E
    E --> F{bypassEnabled && !isButtonTriggered?}
    F -->|æ˜¯| G[ä» prompt.output ç§»é™¤ BatchBox èŠ‚ç‚¹]
    F -->|å¦| H[ä¿ç•™æ‰€æœ‰èŠ‚ç‚¹]
    G --> I[è°ƒç”¨åŸå§‹ queuePrompt]
    H --> I
```

**é…ç½®å­˜å‚¨ (api_config.yaml)ï¼š**

```yaml
node_settings:
  default_width: 500
  bypass_queue_prompt: true  # true=å¼€å¯æ‹¦æˆª, false=æ­£å¸¸æ‰§è¡Œ
```

**æ ¸å¿ƒä»£ç æ¨¡å¼ï¼š**

```javascript
// æ ‡è®°æŒ‰é’®è§¦å‘
let isButtonTriggeredExecution = false;
let bypassQueuePromptEnabled = true;

// æ‹¦æˆª queuePrompt
const origQueuePrompt = api.queuePrompt;
api.queuePrompt = async function(number, workflowData) {
  const wasButtonTriggered = isButtonTriggeredExecution;
  isButtonTriggeredExecution = false; // ç«‹å³é‡ç½®
  
  if (bypassQueuePromptEnabled && !wasButtonTriggered) {
    // ç§»é™¤ BatchBox èŠ‚ç‚¹
    for (const nodeId of batchboxNodeIds) {
      delete workflowData.output[nodeId];
    }
  }
  return origQueuePrompt.call(this, number, workflowData);
};
```

**è®¾ç½®åŒæ­¥æ³¨æ„äº‹é¡¹ï¼š**

å½“ä½¿ç”¨ä¸“ç”¨ API ä¿å­˜è®¾ç½®æ—¶ï¼Œå¿…é¡»åŒæ­¥å›ä¸»é…ç½®å¯¹è±¡ï¼Œå¦åˆ™ä¸»"ä¿å­˜"æŒ‰é’®ä¼šè¦†ç›–ï¼š

```javascript
// ä¿å­˜æˆåŠŸååŒæ­¥
this.config.node_settings = { ...this.config.node_settings, ...newSettings };
```

### 7.9 ç‹¬ç«‹å¹¶å‘ç”Ÿæˆæœºåˆ¶

**åŠŸèƒ½ï¼š** èŠ‚ç‚¹é€šè¿‡ç‹¬ç«‹ API è°ƒç”¨ç”Ÿæˆå†…å®¹ï¼Œå®Œå…¨ç»•è¿‡ ComfyUI çš„ `queue prompt` é˜Ÿåˆ—ï¼Œå®ç°å¤šèŠ‚ç‚¹åŒæ—¶å¹¶å‘æ‰§è¡Œã€‚

**æ ¸å¿ƒä¼˜åŠ¿ï¼š**

| ç‰¹æ€§ | ComfyUI Queue | ç‹¬ç«‹ç”Ÿæˆ |
|------|---------------|----------|
| å¹¶å‘æ€§ | ä¸²è¡Œæ‰§è¡Œ | **å¹¶è¡Œæ‰§è¡Œ** |
| ä¾èµ–ç®¡ç† | è‡ªåŠ¨ | æ‰‹åŠ¨è§£æ |
| å›¾ç‰‡æ¢å¤ | å†…ç½® | æ‰‹åŠ¨æŒä¹…åŒ– |

**å®ç°æµç¨‹ï¼š**

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Button as å¼€å§‹ç”ŸæˆæŒ‰é’®
    participant API as /api/batchbox/generate-independent
    participant Generator as IndependentGenerator
    participant External as å¤–éƒ¨ AI API

    User->>Button: ç‚¹å‡»
    Button->>Button: æ˜¾ç¤º "â³ ç”Ÿæˆä¸­..."
    Button->>API: POST è¯·æ±‚ (model, prompt, seed...)
    API->>Generator: generate()
    Generator->>External: è°ƒç”¨ AI æ¨¡å‹ (asyncio.to_thread)
    External-->>Generator: è¿”å›å›¾ç‰‡
    Generator->>Generator: ä¿å­˜å›¾ç‰‡
    Generator-->>API: è¿”å›é¢„è§ˆä¿¡æ¯
    API-->>Button: JSON å“åº”
    Button->>Button: æ›´æ–°èŠ‚ç‚¹é¢„è§ˆ
    Button->>Button: æ¢å¤ "â–¶ å¼€å§‹ç”Ÿæˆ"
```

**åç«¯å…³é”®å®ç°ï¼ˆv2.20 å¹¶å‘æ§åˆ¶ï¼‰ï¼š**

```python
# independent_generator.py
async def generate(self, model, prompt, seed, batch_count, ...):
    async def process_single_batch(batch_idx):
        current_params = params.copy()
        if seed > 0:
            current_params["seed"] = seed + batch_idx
        # ä½¿ç”¨ asyncio.to_thread é¿å…é˜»å¡äº‹ä»¶å¾ªç¯
        result = await asyncio.to_thread(
            self.execute_with_failover, model, current_params, mode
        )
        return (batch_idx, batch_images, batch_log)
    
    # v2.20: æ™ºèƒ½è‡ªé€‚åº”å¹¶å‘æ§åˆ¶
    def get_max_concurrent():
        if mode == "text2img":
            return batch_count  # Text2img: æ— è¾“å…¥å›¾ç‰‡ï¼Œå…¨éƒ¨å¹¶è¡Œ
        # Img2img: æ ¹æ®åˆ†è¾¨ç‡é™åˆ¶
        resolution = str(extra_params.get("resolution", "")).upper()
        if "4K" in resolution: return 3
        elif "HD" in resolution: return 5
        else: return 6
    
    max_concurrent = get_max_concurrent()
    semaphore = asyncio.Semaphore(max_concurrent)
    
    async def process_with_limit(batch_idx):
        async with semaphore:
            return await process_single_batch(batch_idx)
    
    tasks = [process_with_limit(i) for i in range(batch_count)]
    results = await asyncio.gather(*tasks, return_exceptions=True)
```

**å¹¶å‘æ§åˆ¶ç­–ç•¥ï¼ˆv2.20ï¼‰ï¼š**

| æ¨¡å¼ | åˆ†è¾¨ç‡ | å¹¶å‘æ•° | è¯´æ˜ |
|------|--------|--------|------|
| **Text2img** | ä»»æ„ | **å…¨éƒ¨å¹¶è¡Œ** | æ— è¾“å…¥å›¾ç‰‡ï¼Œæ— å†…å­˜å‹åŠ› |
| Img2img | 4K/2160p | 3 | å¤§å›¾ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º |
| Img2img | HD/1080p | 5 | ä¸­ç­‰å¹³è¡¡ |
| Img2img | å…¶ä»– | 6 | é»˜è®¤ |

**æ»‘åŠ¨çª—å£å·¥ä½œåŸç†ï¼ˆImg2img æ¨¡å¼ï¼‰ï¼š**

```text
æ—¶é—´ â†’
Task1 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘  (å®Œæˆ â†’ Task4 ç«‹å³å¯åŠ¨)
Task2 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘
Task3 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘  (å®Œæˆ â†’ Task5 ç«‹å³å¯åŠ¨)
Task4      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘
Task5        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘
...
å§‹ç»ˆä¿æŒ â‰¤N ä¸ªä»»åŠ¡åŒæ—¶è¿è¡Œï¼ˆNæ ¹æ®åˆ†è¾¨ç‡åŠ¨æ€è°ƒæ•´ï¼‰
```

**å‰ç«¯å…³é”®å®ç°ï¼š**

```javascript
// æ›´æ–°èŠ‚ç‚¹é¢„è§ˆï¼ˆä¿å­˜å°ºå¯¸é¿å…æ¢å¤æ—¶è·³åŠ¨ï¼‰
function updateNodePreview(node, previewImages) {
    node.imgs = previewImages.map(img => {
        const imgEl = new Image();
        imgEl.onload = () => {
            node.setDirtyCanvas(true, true);  // å›¾ç‰‡åŠ è½½åè§¦å‘é‡ç»˜
        };
        imgEl.src = `/view?filename=${img.filename}&t=${Date.now()}`;
        return imgEl;
    });
    
    node.properties._last_images = JSON.stringify(previewImages);
    node.properties._last_size = JSON.stringify(node.size);  // ä¿å­˜å°ºå¯¸
}
```

**æ¢å¤æ—¶æŠ‘åˆ¶è·³åŠ¨ï¼š**

```javascript
// loadedGraphNode ä¸­ä½¿ç”¨ _isRestoring æ ‡å¿—
node._isRestoring = true;  // æŠ‘åˆ¶ä¸­é—´é‡ç»˜
// ... åˆå§‹åŒ–ä»£ç  ...
node._isRestoring = false;
node.setDirtyCanvas(true, true);  // æœ€ç»ˆä¸€æ¬¡æ€§é‡ç»˜
```

**ä¿®æ”¹çš„æ–‡ä»¶ï¼š**

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `independent_generator.py` | åç«¯ç‹¬ç«‹ç”Ÿæˆé€»è¾‘ã€`asyncio.to_thread` é¿å…é˜»å¡ |
| `__init__.py` | æ³¨å†Œ `/api/batchbox/generate-independent` ç«¯ç‚¹ |
| `web/dynamic_params.js` | å‰ç«¯æŒ‰é’®è§¦å‘ã€é¢„è§ˆæ›´æ–°ã€å°ºå¯¸ä¿å­˜ |
| `web/dynamic_inputs.js` | æ¢å¤é€»è¾‘ã€`_isRestoring` æŠ‘åˆ¶æœºåˆ¶ |

### 7.10 é…ç½®çƒ­é‡è½½æœºåˆ¶

**åŠŸèƒ½ï¼š** åœ¨ API Manager ä¸­ä¿å­˜é…ç½®åï¼Œç”»å¸ƒä¸­çš„ BatchBox èŠ‚ç‚¹ç«‹å³åˆ·æ–°å‚æ•°å’Œæ¨¡å‹åˆ—è¡¨ï¼Œæ— éœ€åˆ·æ–°æµè§ˆå™¨ã€‚

**é—®é¢˜èƒŒæ™¯ï¼š**

| é—®é¢˜ | åŸå›  |
|------|------|
| åŠ¨æ€å‚æ•°ä¸åˆ·æ–° | `onModelChange()` è·³è¿‡ç›¸åŒæ¨¡å‹ |
| æ¨¡å‹åˆ—è¡¨ä¸æ›´æ–° | Widget options æ˜¯ Python åç«¯å®šä¹‰çš„é™æ€æ•°æ® |
| éœ€è¦æ‰‹åŠ¨åˆ·æ–°æµè§ˆå™¨ | æ²¡æœ‰äº‹ä»¶é€šçŸ¥æœºåˆ¶ |

**å®ç°æµç¨‹ï¼š**

```mermaid
sequenceDiagram
    participant Manager as API Manager
    participant Backend as Python Backend
    participant Frontend as dynamic_params.js
    participant Canvas as ç”»å¸ƒèŠ‚ç‚¹

    Manager->>Backend: POST /api/batchbox/config
    Manager->>Backend: POST /api/batchbox/reload
    Manager->>Frontend: dispatchEvent("batchbox:config-changed")
    Frontend->>Frontend: clearSchemaCache()
    Frontend->>Backend: GET /api/batchbox/models?category=image
    Backend-->>Frontend: æœ€æ–°æ¨¡å‹åˆ—è¡¨
    Frontend->>Canvas: æ›´æ–° widget.options.values
    Frontend->>Canvas: onModelChange(model, forceRefresh=true)
    Canvas->>Canvas: é‡ç»˜
```

**å‰ç«¯å…³é”®å®ç°ï¼š**

```javascript
// api_manager.js - ä¿å­˜åè§¦å‘çƒ­é‡è½½
async saveConfig() {
    await api.fetchApi("/api/batchbox/config", { method: "POST", body: JSON.stringify(this.config) });
    await api.fetchApi("/api/batchbox/reload", { method: "POST" });  // å¼ºåˆ¶åç«¯åˆ·æ–°
    window.dispatchEvent(new CustomEvent("batchbox:config-changed"));  // é€šçŸ¥å‰ç«¯
}

// dynamic_params.js - ç›‘å¬é…ç½®å˜æ›´
window.addEventListener("batchbox:config-changed", async () => {
    clearSchemaCache();
    // 1. è·å–æœ€æ–°æ¨¡å‹åˆ—è¡¨
    const models = await fetchModelsForCategory(category);
    // 2. æ›´æ–° widget options
    modelWidget.options.values = models.names;
    // 3. å¼ºåˆ¶åˆ·æ–°å‚æ•°
    await node._dynamicParamManager.onModelChange(modelWidget.value, true);
});

// onModelChange æ”¯æŒå¼ºåˆ¶åˆ·æ–°
async onModelChange(modelName, forceRefresh = false) {
    if (modelName === this.currentModel && !forceRefresh) return;  // å…è®¸å¼ºåˆ¶åˆ·æ–°
    // ... ç»§ç»­è·å– schema å¹¶æ›´æ–° widgets
}
```

**ä¿®æ”¹çš„æ–‡ä»¶ï¼š**

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `web/api_manager.js` | ä¿å­˜åè°ƒç”¨ `/api/batchbox/reload` + è§¦å‘ `batchbox:config-changed` äº‹ä»¶ |
| `web/dynamic_params.js` | ç›‘å¬äº‹ä»¶ã€åˆ·æ–°æ¨¡å‹åˆ—è¡¨ã€å¼ºåˆ¶æ›´æ–°å‚æ•°ã€`forceRefresh` å‚æ•° |

### 7.11 ç”»å¸ƒå³é”®èœå•å¿«æ·æ·»åŠ 

**åŠŸèƒ½ï¼š** åœ¨ ComfyUI ç”»å¸ƒç©ºç™½å¤„å³é”®å¯ç›´æ¥æ·»åŠ  BatchBox èŠ‚ç‚¹ï¼Œæ— éœ€åœ¨èŠ‚ç‚¹æµè§ˆå™¨ä¸­æŸ¥æ‰¾ã€‚

**æ”¯æŒçš„èŠ‚ç‚¹ï¼š**

| èœå•é¡¹ | èŠ‚ç‚¹ç±»å‹ |
|--------|----------|
| ğŸ–¼ï¸ Dynamic Image Generation | `DynamicImageGeneration` |
| ğŸ¬ Dynamic Video Generation | `DynamicVideoGeneration` |
| ğŸ“ Dynamic Text Generation | `DynamicTextGeneration` |
| âœï¸ Dynamic Image Editor | `DynamicImageEditor` |
| ğŸ”Š Dynamic Audio Generation | `DynamicAudioGeneration` |

**é…ç½®å¼€å…³ï¼š**

```yaml
node_settings:
  show_in_canvas_menu: true  # true=æ˜¾ç¤º, false=éšè—
```

**å®ç°æ–¹å¼ï¼š**

ComfyUI å®˜æ–¹æ¨èçš„ `getCanvasMenuItems()` hookï¼š

```javascript
app.registerExtension({
  name: "ComfyUI-Custom-Batchbox.DynamicParams",
  
  getCanvasMenuItems() {
    if (!showInCanvasMenuEnabled) return [];  // å°Šé‡è®¾ç½®
    
    return batchboxNodes.map(nodeInfo => ({
      content: nodeInfo.label,
      callback: () => {
        const node = LiteGraph.createNode(nodeInfo.type);
        node.pos = [canvas.graph_mouse[0], canvas.graph_mouse[1]];
        app.graph.add(node);
      }
    }));
  }
});
```

**çƒ­é‡è½½æœºåˆ¶ï¼š**

è®¾ç½®å˜æ›´åæ— éœ€åˆ·æ–°é¡µé¢å³å¯ç”Ÿæ•ˆï¼š

1. API Manager ä¿å­˜è®¾ç½® â†’ è°ƒç”¨ `/api/batchbox/node-settings`
2. è§¦å‘ `batchbox:node-settings-changed` äº‹ä»¶
3. `dynamic_params.js` ç›‘å¬äº‹ä»¶ â†’ `fetchNodeSettings()` æ›´æ–° `showInCanvasMenuEnabled`
4. ä¸‹æ¬¡å³é”®æ—¶ `getCanvasMenuItems()` è‡ªåŠ¨è¿”å›æ­£ç¡®ç»“æœ

**ä¿®æ”¹çš„æ–‡ä»¶ï¼š**

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `web/dynamic_params.js` | `getCanvasMenuItems()` hook + çƒ­é‡è½½é€»è¾‘ |
| `web/api_manager.js` | "å³é”®èœå•å¿«æ·æ·»åŠ " å¼€å…³ UI |

### 7.13 åŠ¨æ€æ§½ä½ç´§å‡‘ç­–ç•¥

**åŠŸèƒ½ï¼š** æ–­å¼€ä¸­é—´è¾“å…¥æ§½ä½åï¼Œè¿æ¥è‡ªåŠ¨å‘å‰ç§»åŠ¨å¡«è¡¥ç©ºéš™ï¼Œä¿æŒæ§½ä½ç´§å‡‘ã€‚

**æ ¸å¿ƒé—®é¢˜ï¼š**

```
åŸçŠ¶æ€ï¼šimage1(è¿æ¥A) â†’ image2(ç©º) â†’ image3(è¿æ¥B) â†’ image4(ç©º)
æ–­å¼€ image1 åï¼š
  âŒ æ—§è¡Œä¸ºï¼šimage1(ç©º) â†’ image2(ç©º) â†’ image3(è¿æ¥B) â†’ image4(ç©º)
  âœ… æ–°è¡Œä¸ºï¼šimage1(è¿æ¥B) â†’ image2(ç©º)
```

**å®ç°ç­–ç•¥ï¼šå­˜å‚¨-åˆ é™¤-é‡å»º-é‡è¿**

```mermaid
flowchart LR
    A[æ”¶é›†æ‰€æœ‰è¿æ¥ä¿¡æ¯] --> B[ä¿å­˜ sourceNodeId + sourceSlot]
    B --> C[åˆ é™¤æ‰€æœ‰è¯¥ç±»å‹æ§½ä½]
    C --> D[æŒ‰ç´§å‡‘é¡ºåºé‡å»ºæ§½ä½]
    D --> E[ä½¿ç”¨ä¿å­˜çš„æºèŠ‚ç‚¹ä¿¡æ¯é‡è¿]
```

**å…³é”®å®ç°ï¼š**

```javascript
// web/dynamic_inputs.js - updateInputsForType()
// 1. æ”¶é›†è¿æ¥ä¿¡æ¯ï¼ˆä¸ä½¿ç”¨ link IDï¼Œåˆ é™¤åä¼šå¤±æ•ˆï¼‰
const connections = [];
for (let i = 1; i <= currentInputCount; i++) {
    const input = node.inputs.find(inp => inp.name === `${prefix}${i}`);
    if (input?.link) {
        const linkInfo = graph.links[input.link];
        if (linkInfo) {
            connections.push({
                sourceNodeId: linkInfo.origin_id,
                sourceSlot: linkInfo.origin_slot
            });
        }
    }
}

// 2. åˆ é™¤æ‰€æœ‰æ§½ä½
while (slotExists) { node.removeInput(slotIndex); }

// 3. æŒ‰ç´§å‡‘é¡ºåºé‡å»º
for (let i = 1; i <= connections.length + 1; i++) {
    node.addInput(`${prefix}${i}`, inputType);
}

// 4. ä½¿ç”¨æºèŠ‚ç‚¹ä¿¡æ¯é‡è¿
for (let i = 0; i < connections.length; i++) {
    const sourceNode = graph.getNodeById(conn.sourceNodeId);
    sourceNode.connect(conn.sourceSlot, node, inputIndex);
}
```

**ä¸ºä»€ä¹ˆä¸ç”¨ Link IDï¼š**

| æ–¹å¼ | é—®é¢˜ |
|------|------|
| Link ID | åˆ é™¤æ§½ä½å link è¢«é”€æ¯ï¼ŒID å¤±æ•ˆ |
| sourceNodeId + sourceSlot | âœ… èŠ‚ç‚¹å’Œæ§½ä½ç‹¬ç«‹äº link å­˜åœ¨ |

**ä¿®æ”¹çš„æ–‡ä»¶ï¼š**

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `web/dynamic_inputs.js` | `updateInputsForType()` ç´§å‡‘ç­–ç•¥å®ç° |

### 7.14 æ™ºèƒ½ç¼“å­˜ï¼šèŠ‚ç‚¹ä½œä¸ºå›¾ç‰‡æ¥æº

**åŠŸèƒ½ï¼š** è®© BatchBox èŠ‚ç‚¹åœ¨å·²ç”Ÿæˆå›¾ç‰‡åï¼Œè¡Œä¸ºç±»ä¼¼ Load Image èŠ‚ç‚¹ï¼š
- å·²ç”Ÿæˆå›¾ç‰‡çš„èŠ‚ç‚¹åœ¨ Queue Prompt æ—¶**ä¸è°ƒç”¨ API**ï¼Œç›´æ¥è¿”å›ç¼“å­˜å›¾ç‰‡
- ä¸‹æ¸¸èŠ‚ç‚¹èƒ½æ­£å¸¸æ¥æ”¶åˆ°è¿™äº›å›¾ç‰‡
- å³ä½¿é‡å¯ ComfyUI ä¹Ÿèƒ½æ¢å¤

**é€‚ç”¨åœºæ™¯ï¼š**
- **å¼€å¯"æ‹¦æˆªå…¨å±€ Queue Prompt"**ï¼šèŠ‚ç‚¹ä¸æ‰§è¡Œï¼Œä½†ä¸‹æ¸¸èŠ‚ç‚¹ä»èƒ½æ¥æ”¶åˆ°ä¹‹å‰ç”Ÿæˆçš„å›¾ç‰‡
- **å…³é—­"æ‹¦æˆªå…¨å±€ Queue Prompt"**ï¼šå¦‚æœå‚æ•°æœªå˜ï¼Œç›´æ¥è¿”å›ç¼“å­˜å›¾ç‰‡

**é—®é¢˜èƒŒæ™¯ï¼š**

ç‹¬ç«‹ç”Ÿæˆï¼ˆ"å¼€å§‹ç”Ÿæˆ"æŒ‰é’®ï¼‰å’Œ Queue Prompt ä¹‹é—´æ— æ³•æ­£ç¡®å…±äº«ç¼“å­˜ï¼š
- ç‹¬ç«‹ç”Ÿæˆåç‚¹å‡» Queue Prompt ä¼šé‡å¤è°ƒç”¨ API
- åŸå› ï¼šå‰ç«¯å’Œåç«¯åˆ†åˆ«è®¡ç®—å“ˆå¸Œï¼Œç»“æœä¸ä¸€è‡´

**æ ¸å¿ƒé—®é¢˜ï¼š**

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| JSON æ ¼å¼å·®å¼‚ | Python é»˜è®¤ `{"key": "value"}`ï¼ŒJS é»˜è®¤ `{"key":"value"}` | Python ä½¿ç”¨ `separators=(',', ':')` |
| å‰åç«¯åˆ†åˆ«è®¡ç®— | ç»†å¾®å·®å¼‚å¯¼è‡´å“ˆå¸Œä¸åŒ¹é… | ç»Ÿä¸€ç”±åç«¯è®¡ç®— |
| extra_params åŒ…å« seed | ä¸ç‹¬ç«‹ seed å­—æ®µå†²çª | å“ˆå¸Œè®¡ç®—æ—¶æ’é™¤ seed |

**å®ç°æµç¨‹ï¼š**

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å‰ç«¯
    participant IG as IndependentGenerator
    participant N as nodes.py
    
    Note over U,N: ç‹¬ç«‹ç”Ÿæˆæµç¨‹
    U->>F: ç‚¹å‡»"å¼€å§‹ç”Ÿæˆ"
    F->>IG: /api/batchbox/generate-independent
    IG->>IG: ç”Ÿæˆå›¾ç‰‡ + _compute_params_hash()
    IG-->>F: {preview_images, params_hash}
    F->>F: ä¿å­˜ params_hash åˆ° node.properties._cached_hash
    
    Note over U,N: Queue Prompt æµç¨‹
    U->>F: ç‚¹å‡» Queue Prompt
    F->>F: æ³¨å…¥ _cached_hash åˆ° workflow
    F->>N: æ‰§è¡ŒèŠ‚ç‚¹
    N->>N: _compute_params_hash() (ç›¸åŒé€»è¾‘)
    N->>N: æ¯”è¾ƒ hash â†’ åŒ¹é…ï¼
    N-->>F: ä½¿ç”¨ç¼“å­˜å›¾ç‰‡ï¼ˆè·³è¿‡ API è°ƒç”¨ï¼‰
```

**åç«¯å…³é”®å®ç°ï¼š**

```python
# independent_generator.py
def _compute_params_hash(self, model, prompt, batch_count, seed, extra_params):
    """ä¸ nodes.py ä½¿ç”¨å®Œå…¨ç›¸åŒçš„é€»è¾‘"""
    params_for_hash = dict(extra_params) if extra_params else {}
    params_for_hash.pop("seed", None)  # æ’é™¤ seed
    
    # ç´§å‡‘æ ¼å¼åŒ¹é… JavaScript
    extra_params_normalized = json.dumps(params_for_hash, sort_keys=True, separators=(',', ':'))
    
    params_str = f"{model}|{prompt}|{batch_count}|{seed}|{extra_params_normalized}"
    return hashlib.md5(params_str.encode()).hexdigest()

async def generate(self, ...):
    # ... ç”Ÿæˆå›¾ç‰‡ ...
    params_hash = self._compute_params_hash(model, prompt, batch_count, seed, extra_params)
    return {
        "success": True,
        "preview_images": all_previews,
        "params_hash": params_hash  # è¿”å›åç«¯è®¡ç®—çš„å“ˆå¸Œ
    }
```

**å‰ç«¯å…³é”®å®ç°ï¼š**

```javascript
// dynamic_params.js - executeIndependent()
const result = await response.json();
if (result.success) {
    // ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„å“ˆå¸Œï¼Œä¸å†å‰ç«¯è®¡ç®—
    const paramsHash = result.params_hash;
    updateNodePreview(node, result.preview_images, paramsHash);
}
```

**"å‚æ•°å˜åŒ–æ£€æµ‹"è®¾ç½®ï¼š**

| çŠ¶æ€ | è¡Œä¸º |
|------|------|
| å¼€å¯ï¼ˆé»˜è®¤ï¼‰ | ä¿®æ”¹å‚æ•°å Queue Prompt ä¼šé‡æ–°ç”Ÿæˆ |
| å…³é—­ | å¿½ç•¥å‚æ•°å˜åŒ–ï¼Œä»…æŒ‰é’®è§¦å‘ç”Ÿæˆ |

**é…ç½®å­˜å‚¨ï¼š**

```yaml
node_settings:
  smart_cache_hash_check: true  # true=æ£€æµ‹å‚æ•°å˜åŒ–, false=ä»…æŒ‰é’®è§¦å‘
```

**ä¿®æ”¹çš„æ–‡ä»¶ï¼š**

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `config_manager.py` | æ·»åŠ  `smart_cache_hash_check` é»˜è®¤è®¾ç½® |
| `api_manager.js` | æ·»åŠ è®¾ç½® UI å¤é€‰æ¡† |
| `dynamic_params.js` | è¯»å–è®¾ç½®ã€æ³¨å…¥å‚æ•°ã€ä½¿ç”¨åç«¯å“ˆå¸Œ |
| `nodes.py` | æ·»åŠ  `_skip_hash_check` è¾“å…¥ï¼Œä¿®å¤ JSON æ ¼å¼ |
| `independent_generator.py` | æ·»åŠ  `_compute_params_hash()` å¹¶è¿”å›å“ˆå¸Œ |

### 7.15 é€‰ä¸­å›¾ç‰‡æ”¾å¤§æ˜¾ç¤º

**åŠŸèƒ½ï¼š** ç”Ÿæˆå¤šå¼ å›¾åï¼ŒèŠ‚ç‚¹è‡ªåŠ¨æ”¾å¤§æ˜¾ç¤ºé€‰ä¸­çš„å›¾ç‰‡ï¼ˆé»˜è®¤ç¬¬ä¸€å¼ ï¼‰ï¼Œå¹¶åœ¨æ‰§è¡Œåä¿æŒæ”¾å¤§çŠ¶æ€ï¼š

| åœºæ™¯ | è¡Œä¸º |
|------|------|
| ç”Ÿæˆå®Œæˆå | é»˜è®¤ç¬¬ä¸€å¼ æ”¾å¤§æ˜¾ç¤ºï¼Œè¾“å‡ºç»™ä¸‹æ¸¸ |
| ç‚¹å‡» X æŒ‰é’® | å›åˆ°ç¼©ç•¥å›¾æ¨¡å¼ |
| ç‚¹å‡»ç¼©ç•¥å›¾ | è¯¥å›¾ç‰‡æ”¾å¤§æ˜¾ç¤º |
| Queue Prompt | ä¿æŒæ”¾å¤§æ˜¾ç¤ºï¼Œè¾“å‡ºé€‰ä¸­å›¾ç‰‡ |
| é‡å¯æ¢å¤ | é€‰ä¸­å›¾ç‰‡ä¿¡æ¯æŒä¹…åŒ–ï¼Œä¾æ—§æ”¾å¤§æ˜¾ç¤º |

**é—®é¢˜èƒŒæ™¯ï¼š**

ComfyUI çš„æ¸²æŸ“å¾ªç¯åœ¨æ¯ä¸€å¸§éƒ½ä¼šè°ƒç”¨ `imageIndex = null`ï¼Œè¿™ä¼šè¦†ç›–ç”¨æˆ·çš„é€‰æ‹©ï¼Œå¯¼è‡´æ‰§è¡Œåé—ªå›ç¼©ç•¥å›¾ã€‚

**æ ¸å¿ƒè§£å†³æ–¹æ¡ˆï¼šProperty Interception + Execution Window Guard**

```javascript
// dynamic_params.js - æ‹¦æˆª imageIndex setter
Object.defineProperty(this, 'imageIndex', {
  set: function(value) {
    // ä»…åœ¨æ‰§è¡Œçª—å£æœŸé—´é˜»æ­¢ null
    if ((value === null) && selfNode._ignoreImageIndexChanges) {
      selfNode._imageIndexInternal = selfNode._selectedImageIndex || 0;
      return;  // é˜»æ­¢
    }
    selfNode._imageIndexInternal = value;  // å…¶ä»–æ—¶å€™å…è®¸
  }
});
```

**æ—¶é—´çª—å£æ§åˆ¶ï¼š**

```javascript
// dynamic_inputs.js - onExecuted
this._ignoreImageIndexChanges = true;
this.imageIndex = selectedIdx;

setTimeout(() => {
    this._ignoreImageIndexChanges = false;
}, 100);  // 100ms è¶³å¤Ÿ ComfyUI æ¸²æŸ“å®Œæˆ
```

**ä¿®æ”¹çš„æ–‡ä»¶ï¼š**

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `web/dynamic_params.js` | imageIndex setter æ‹¦æˆªï¼Œé˜»æ­¢æ‰§è¡ŒæœŸé—´çš„ null |
| `web/dynamic_inputs.js` | onExecuted ä¸­è®¾ç½®é€‰ä¸­ç´¢å¼•ï¼Œ100ms åæ¢å¤ |

**ç”¨æˆ·äº¤äº’æµç¨‹ï¼ˆç®€ç‰ˆï¼‰ï¼š**

```mermaid
flowchart TD
    A[ç”Ÿæˆå®Œæˆ] --> B[é»˜è®¤é€‰æ‹©ç¬¬ä¸€å¼ ]
    B --> C[æ”¾å¤§æ˜¾ç¤ºé€‰ä¸­å›¾ç‰‡]
    C --> D{ç”¨æˆ·æ“ä½œ}
    
    D -->|ç‚¹å‡» X æŒ‰é’®| E[è¿”å›ç¼©ç•¥å›¾æ¨¡å¼]
    E --> F[æ˜¾ç¤ºæ‰€æœ‰ç¼©ç•¥å›¾]
    F --> G{ç‚¹å‡»ç¼©ç•¥å›¾}
    G --> H[é€‰ä¸­è¯¥å›¾ç‰‡]
    H --> C
    
    D -->|ç‚¹å‡» Queue Prompt| I[åŒæ­¥ _selected_image_index]
    I --> J[åç«¯æ ¹æ®ç´¢å¼•åˆ‡ç‰‡ tensor]
    J --> K[è¾“å‡ºé€‰ä¸­å›¾ç‰‡ç»™ä¸‹æ¸¸]
    K --> C
    
    D -->|é‡å¯ ComfyUI| L[ä» properties è¯»å–ç´¢å¼•]
    L --> C
```

**ç”¨æˆ·äº¤äº’æµç¨‹ï¼ˆå«æŠ€æœ¯å®ç°ç»†èŠ‚ï¼‰ï¼š**

```mermaid
flowchart TD
    A[ç”Ÿæˆå®Œæˆ] --> B[é»˜è®¤é€‰æ‹©ç¬¬ä¸€å¼ ]
    B --> C[æ”¾å¤§æ˜¾ç¤ºé€‰ä¸­å›¾ç‰‡]
    C --> D{ç”¨æˆ·æ“ä½œ}
    
    D -->|ç‚¹å‡» X æŒ‰é’®| E[è¿”å›ç¼©ç•¥å›¾æ¨¡å¼]
    E --> F[æ˜¾ç¤ºæ‰€æœ‰ç¼©ç•¥å›¾]
    F --> G{ç‚¹å‡»ç¼©ç•¥å›¾}
    G --> H[é€‰ä¸­è¯¥å›¾ç‰‡]
    H --> C
    
    D -->|ç‚¹å‡» Queue Prompt| I[åŒæ­¥ _selected_image_index]
    I --> J[åç«¯æ ¹æ®ç´¢å¼•åˆ‡ç‰‡ tensor]
    J --> K[è¾“å‡ºé€‰ä¸­å›¾ç‰‡ç»™ä¸‹æ¸¸]
    K --> C
    
    D -->|é‡å¯ ComfyUI| L[ä» properties è¯»å–ç´¢å¼•]
    L --> C
    
    subgraph æŠ€æœ¯ç»†èŠ‚_ç”Ÿæˆå®Œæˆ
        A1["onExecuted()"]
        A2["_ignoreImageIndexChanges = true"]
        A3["imageIndex = 0"]
        A4["setTimeout(100ms) è§£é™¤ä¿æŠ¤"]
    end
    A -.-> A1 --> A2 --> A3 --> A4
    
    subgraph æŠ€æœ¯ç»†èŠ‚_é€‰æ‹©åŒæ­¥
        I1["queuePrompt æ‹¦æˆª"]
        I2["workflowData.output[nodeId]._selected_image_index"]
        I3["æ³¨å…¥åˆ° prompt æ•°æ®"]
    end
    I -.-> I1 --> I2 --> I3
    
    subgraph æŠ€æœ¯ç»†èŠ‚_åç«¯åˆ‡ç‰‡
        J1["nodes.py: generate()"]
        J2["selected_tensor = images_tensor[idx:idx+1]"]
        J3["return selected_tensor, all_images"]
    end
    J -.-> J1 --> J2 --> J3
    
    subgraph æŠ€æœ¯ç»†èŠ‚_æŒä¹…åŒ–
        L1["åŠ¨æ€_inputs.js: loadedGraphNode"]
        L2["node.properties._selected_image_index"]
        L3["node.imageIndex = savedIdx"]
    end
    L -.-> L1 --> L2 --> L3
```

**è¡Œä¸ºä¸å®ç°å¯¹ç…§è¡¨ï¼š**

| ç”¨æˆ·è¡Œä¸º | æŠ€æœ¯å®ç° | æ–‡ä»¶ä½ç½® |
|----------|----------|----------|
| ç”Ÿæˆå®Œæˆåæ”¾å¤§ | `onExecuted()` è®¾ç½® `imageIndex = 0` + 100ms null é˜»æ­¢ | `dynamic_inputs.js` |
| ç‚¹å‡» X å›ç¼©ç•¥å›¾ | ComfyUI åŸç”Ÿè®¾ç½® `imageIndex = null` | ComfyUI æ ¸å¿ƒ |
| ç‚¹å‡»ç¼©ç•¥å›¾æ”¾å¤§ | setter ä¿å­˜ `_selectedImageIndex` | `dynamic_params.js` |
| Queue Prompt è¾“å‡º | æ³¨å…¥ `_selected_image_index` â†’ åç«¯ tensor åˆ‡ç‰‡ | `dynamic_params.js` â†’ `nodes.py` |
| é‡å¯æ¢å¤é€‰æ‹© | ä» `properties._selected_image_index` è¯»å– | `dynamic_inputs.js` |

**è®¾è®¡å†³ç­–ï¼š**

| é€‰é¡¹ | é€‰æ‹© | åŸå›  |
|------|------|------|
| é˜»å¡æ¨¡å¼ vs éé˜»å¡ | âœ… éé˜»å¡ | æ— éœ€ç­‰å¾…ç”¨æˆ·é€‰æ‹©ï¼Œç«‹å³è¾“å‡ºç¬¬ä¸€å¼  |
| onMouseDown + setTimeout | âœ… Object.defineProperty | æ›´å¯é ï¼Œæ— æ—¶åºç«äº‰ |
| è‡ªå®šä¹‰ X æŒ‰é’® | âœ… ä½¿ç”¨ ComfyUI åŸç”Ÿ | æ›´ç®€æ´ï¼Œåˆ©ç”¨ç°æœ‰ UI |

**æŠ€æœ¯å®ç°æ—¶åºï¼š**

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant C as ComfyUI æ¸²æŸ“å¾ªç¯
    participant S as imageIndex Setter
    participant N as Node çŠ¶æ€
    
    Note over U,N: æ‰§è¡ŒæœŸé—´ï¼ˆ100ms çª—å£å†…ï¼‰
    U->>N: Queue Prompt
    N->>N: _ignoreImageIndexChanges = true
    N->>S: imageIndex = selectedIdx
    S->>N: ä¿å­˜åˆ° _imageIndexInternal
    
    loop æ¯å¸§æ¸²æŸ“
        C->>S: imageIndex = null
        S--xS: é˜»æ­¢ï¼ˆguard = trueï¼‰
        S->>N: ä¿æŒ _selectedImageIndex
    end
    
    Note over N: 100ms å
    N->>N: _ignoreImageIndexChanges = false
    
    Note over U,N: æ­£å¸¸çŠ¶æ€
    U->>S: ç‚¹å‡» Xï¼ˆè®¾ç½® nullï¼‰
    S->>N: å…è®¸ï¼Œæ˜¾ç¤ºç¼©ç•¥å›¾
    
    U->>S: ç‚¹å‡»å›¾ç‰‡ï¼ˆè®¾ç½® indexï¼‰
    S->>N: å…è®¸ï¼Œæ”¾å¤§æ˜¾ç¤º
    S->>N: ä¿å­˜ _selectedImageIndex
```

### 7.16 è¯·æ±‚ä½“æ— é™åˆ¶è¯»å–ï¼ˆv2.19ï¼‰

**é—®é¢˜èƒŒæ™¯ï¼š**

`generate-independent` API ç«¯ç‚¹æ¥æ”¶å¤§å‹ base64 å›¾ç‰‡æ—¶ï¼Œä¼šè§¦å‘ `HTTPRequestEntityTooLarge` é”™è¯¯ã€‚aiohttp é»˜è®¤çš„ `request.json()` æ–¹æ³•æœ‰çº¦ 1MB çš„é™åˆ¶ã€‚

**è§£å†³æ–¹æ¡ˆï¼šåˆ†å—è¿­ä»£è¯»å–**

```python
# __init__.py - generate_independent å‡½æ•°
chunks = []
async for chunk in request.content.iter_any():
    chunks.append(chunk)

body = b''.join(chunks)
data = json.loads(body)
```

**å…³é”®è®¾è®¡å†³ç­–ï¼š**

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| `HTTPRequestEntityTooLarge` | aiohttp é»˜è®¤é™åˆ¶ ~1MB | ä½¿ç”¨ `iter_any()` ç»•è¿‡é™åˆ¶ |
| `JSONDecodeError: Unterminated string` | `read(limit)` å¯èƒ½åœ¨æ•°æ®æœªå®Œå…¨åˆ°è¾¾æ—¶è¿”å› | ä½¿ç”¨ `iter_any()` ç¡®ä¿å®Œæ•´è¯»å– |
| å†…å­˜å ç”¨ | æ— é™åˆ¶å¯èƒ½å¯¼è‡´å†…å­˜é—®é¢˜ | ä¾èµ–ä¸Šæ¸¸ï¼ˆå¦‚ Nginxï¼‰é™åˆ¶ |

**ä¿®æ”¹çš„æ–‡ä»¶ï¼š**

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `__init__.py` | `generate_independent` å‡½æ•°ä½¿ç”¨åˆ†å—è¯»å– |

### 7.17 å…±äº«å›¾ç‰‡æ•°æ®ä¼˜åŒ–ï¼ˆv2.20ï¼‰

**é—®é¢˜èƒŒæ™¯ï¼š**

Img2img æ‰¹é‡ç”Ÿæˆæ—¶ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½è¦é‡æ–°ç¼–è§£ç  base64 å›¾ç‰‡æ•°æ®ï¼ŒN ä¸ªæ‰¹æ¬¡å°±æœ‰ N ä»½å›¾ç‰‡å‰¯æœ¬åœ¨å†…å­˜ä¸­ï¼Œå¯¼è‡´ `MemoryError`ã€‚

**è§£å†³æ–¹æ¡ˆï¼šä¸€æ¬¡ç¼–è§£ç ï¼Œæ‰€æœ‰æ‰¹æ¬¡å…±äº«å¼•ç”¨**

```python
# independent_generator.py - é¢„å¤„ç†é˜¶æ®µ
shared_upload_files = []
for img_b64 in images_base64:
    img_bytes = base64.b64decode(img_b64)  # è§£ç ä¸€æ¬¡
    # 4 å…ƒç»„ï¼š(filename, bytes, mime, cached_base64)
    shared_upload_files.append((
        "image.png",
        (filename, img_bytes, "image/png", img_b64)  # ç¼“å­˜ base64
    ))
params["_upload_files"] = shared_upload_files  # æ‰€æœ‰æ‰¹æ¬¡å…±äº«

# generic.py - ä½¿ç”¨ç¼“å­˜
if len(file_tuple) >= 4:
    _, _, mime_type, cached_b64 = file_tuple  # ç›´æ¥ç”¨ç¼“å­˜
else:
    b64_data = base64.b64encode(file_bytes)   # å›é€€
```

**å†…å­˜å ç”¨å¯¹æ¯”ï¼š**

```text
ä¹‹å‰ï¼šBatch 1: decodeâ†’bytesâ†’encode  (Ã—N ä»½å‰¯æœ¬)
      Batch 2: decodeâ†’bytesâ†’encode
      ...
      
ç°åœ¨ï¼šé¢„å¤„ç†: decodeâ†’bytes + cache_b64  (ä»… 1 ä»½)
      Batch 1-N: å…±äº«å¼•ç”¨ â†’ å‘é€
```

| åœºæ™¯ | ä¹‹å‰å†…å­˜ | ç°åœ¨å†…å­˜ |
|------|----------|----------|
| 10 æ‰¹ Ã— 4MB å›¾ç‰‡ | ~40MB | ~4MB |
| 50 æ‰¹ Ã— 8MB å›¾ç‰‡ | ~400MB | ~8MB |

**ä¿®æ”¹çš„æ–‡ä»¶ï¼š**

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `independent_generator.py` | é¢„ç¼“å­˜ bytes + base64ï¼Œå…¨éƒ¨æ‰¹æ¬¡å¹¶è¡Œ |
| `adapters/generic.py` | `_build_gemini_payload` å’Œ `_prepare_images_base64` ä½¿ç”¨ç¼“å­˜ |

### 7.18 åŠ¨æ€ç¼“å­˜åŠ è½½ä¼˜åŒ–ï¼ˆv2.21ï¼‰

**é—®é¢˜èƒŒæ™¯ï¼š**

ä»ç¼“å­˜åŠ è½½ 4K å›¾ç‰‡æ—¶ï¼Œæ¯å¼ å›¾ç‰‡ä½œä¸º float32 tensor éœ€è¦ ~195MB å†…å­˜ã€‚åŠ è½½ 6 å¼  4K å›¾å°±éœ€è¦ ~1.2GBï¼Œå¯¼è‡´ `MemoryError`ã€‚

**è§£å†³æ–¹æ¡ˆï¼šæ ¹æ®è¾“å‡ºç«¯å£è¿æ¥çŠ¶æ€åŠ¨æ€å†³å®šåŠ è½½ç­–ç•¥**

```python
# å‰ç«¯æ£€æµ‹ all_images è¾“å‡ºç«¯å£æ˜¯å¦è¿æ¥
const allImagesConnected = node.outputs[1]?.links?.length > 0;
nodeData.inputs._all_images_connected = allImagesConnected ? "true" : "false";

# åç«¯æ ¹æ®è¿æ¥çŠ¶æ€åŠ è½½
def _load_persisted_images(self, json, selected_index, load_all=False):
    if load_all:
        # åŠ è½½å…¨éƒ¨å›¾ç‰‡ï¼ˆall_images å·²è¿æ¥ï¼‰
        for info in image_infos:
            tensors.append(load_single_image(info))
        return selected_tensor, torch.cat(tensors), infos
    else:
        # åªåŠ è½½é€‰ä¸­çš„ï¼ˆå†…å­˜ä¼˜åŒ–ï¼‰
        tensor = load_single_image(image_infos[selected_index])
        return tensor, tensor, infos
```

**å†…å­˜å ç”¨å¯¹æ¯”ï¼ˆ6 å¼  4K å›¾ç‰‡ï¼‰ï¼š**

| è¾“å‡ºè¿æ¥çŠ¶æ€ | åŠ è½½ç­–ç•¥ | å†…å­˜å ç”¨ |
|-------------|---------|----------|
| åªè¿ `selected_image` | åŠ è½½ 1 å¼  | ~195 MB |
| è¿äº† `all_images` | åŠ è½½å…¨éƒ¨ | ~1.2 GB |

**ä¿®æ”¹çš„æ–‡ä»¶ï¼š**

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `nodes.py` | æ·»åŠ  `_all_images_connected` hidden inputï¼Œ`_load_persisted_images` æ”¯æŒ `load_all` å‚æ•° |
| `web/dynamic_params.js` | æ£€æµ‹ `node.outputs[1].links` å¹¶æ³¨å…¥è¿æ¥çŠ¶æ€ |

### 7.19 DOM Overlay UIï¼ˆv2.22 å®éªŒæ€§ï¼‰

**åŠŸèƒ½ï¼š** åŸºäº DOM çš„ç°ä»£åŒ–èŠ‚ç‚¹ç•Œé¢ï¼Œæ›¿ä»£ä¼ ç»Ÿ Canvas ç»˜åˆ¶æ–¹å¼ï¼Œè§£å†³ LiteGraph z-order å†²çªã€‚

> âš ï¸ **å®éªŒæ€§åˆ†æ”¯**: `feature/dom-overlay-ui`

---

#### 7.19.1 æ ¸å¿ƒé—®é¢˜ï¼šCanvas z-order å†²çª

LiteGraph çš„åŸç”Ÿ widget é€šè¿‡å†…éƒ¨æ¸²æŸ“å¾ªç¯ç»˜åˆ¶ï¼Œå§‹ç»ˆè¦†ç›– `onDrawForeground` çš„è‡ªå®šä¹‰ç»˜åˆ¶ã€‚DOM overlay é€šè¿‡å°† UI å…ƒç´ æ”¾åœ¨ç‹¬ç«‹çš„ DOM å±‚è§£å†³æ­¤é—®é¢˜ã€‚

#### 7.19.2 Portal Container æ¨¡å¼

åœ¨ `document.body` æ³¨å…¥å…¨å±€å®¹å™¨ï¼Œé¿å…çˆ¶å…ƒç´ è£å‰ªï¼š

```javascript
function getOverlayContainer() {
    let container = document.getElementById("batchbox-overlay-container");
    if (!container) {
        container = document.createElement("div");
        container.id = "batchbox-overlay-container";
        container.style.cssText = `
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;  /* ç‚¹å‡»ç©¿é€åˆ° Canvas */
            z-index: 100;
        `;
        document.body.appendChild(container);
    }
    return container;
}
```

#### 7.19.3 ä¸»é¢˜é…ç½®ï¼ˆTHEMEï¼‰

é›†ä¸­ç®¡ç†é¢œè‰²ã€å°ºå¯¸ã€å­—ä½“ï¼š

```javascript
const THEME = {
    // é¢œè‰²
    bgPrimary: "#1e1e2e",     // ä¸»èƒŒæ™¯
    bgSecondary: "#181825",   // æ¬¡çº§èƒŒæ™¯
    accent: "#4CAF50",        // å¼ºè°ƒè‰²ï¼ˆç”ŸæˆæŒ‰é’®ï¼‰
    text: "#cdd6f4",          // æ–‡å­—
    textMuted: "#6c7086",     // æ¬¡çº§æ–‡å­—
    border: "rgba(255,255,255,0.1)",
    
    // å°ºå¯¸
    toolbarHeight: 44,
    buttonHeight: 32,
    buttonRadius: 6,
    promptHeight: 100,
    
    // å­—ä½“
    fontFamily: "-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif",
    fontSize: 13,
};
```

#### 7.19.4 ç»„ä»¶æ¶æ„

```mermaid
graph TD
    A[NodeOverlay ç±»] --> B[Overlay Container]
    B --> P[Image Preview å›¾ç‰‡é¢„è§ˆåŒº]
    B --> C[Prompt Textarea æç¤ºè¯è¾“å…¥]
    B --> D[Toolbar å·¥å…·æ ]
    B --> E[Advanced Panel é«˜çº§è®¾ç½®]
    
    D --> D1[ğŸŒ Model - æ¨¡å‹åˆ‡æ¢]
    D --> D2[ğŸ¨ é£æ ¼ - é£æ ¼å¾ªç¯]
    D --> D3[ğŸ“ åˆ†è¾¨ç‡ - åˆ†è¾¨ç‡å¾ªç¯]
    D --> D4[ğŸ“ æ¯”ä¾‹ - æ¯”ä¾‹å¾ªç¯]
    D --> D5[ğŸ”¢ æ‰¹é‡ - 1-8 å¾ªç¯]
    D --> D6[âš™ï¸ æ›´å¤š - å±•å¼€é«˜çº§]
    D --> D7[â–¶ ç”Ÿæˆ - è§¦å‘æ‰§è¡Œ]
```

#### 7.19.5 æ¯”ä¾‹ç¼©æ”¾åŒæ­¥

ä½¿ç”¨ CSS `transform: scale()` ç¡®ä¿ DOM ä¸ Canvas ç¼©æ”¾ä¸€è‡´ï¼š

```javascript
updatePosition() {
    const canvas = app.canvas;
    const scale = canvas.ds?.scale || 1;
    const offset = canvas.ds?.offset || [0, 0];
    
    // 1. è®¡ç®—èŠ‚ç‚¹çš„å±å¹•åæ ‡
    const nodeX = (this.node.pos[0] + offset[0]) * scale;
    const nodeY = (this.node.pos[1] + offset[1]) * scale;
    const nodeW = this.node.size[0] * scale;
    
    // 2. å®šä½å®¹å™¨
    this.container.style.left = `${nodeX}px`;
    this.container.style.top = `${nodeY + 30 * scale}px`;  // è·³è¿‡æ ‡é¢˜æ 
    this.container.style.width = `${nodeW - 20}px`;
    
    // 3. CSS ç¼©æ”¾ä¿æŒæ¯”ä¾‹
    this.container.style.transform = `scale(${scale})`;
    this.container.style.transformOrigin = "top left";
}
```

#### 7.19.6 é«˜æ€§èƒ½åŒæ­¥æ¡¥æ¥

ä¸‰é‡è§¦å‘æœºåˆ¶ç¡®ä¿å¹³æ»‘è·Ÿéšï¼š

```javascript
attachToCanvas() {
    const update = () => this.updatePosition();
    
    // 1. Canvas Mouse äº‹ä»¶
    const canvasEl = document.querySelector("canvas.graphcanvas");
    canvasEl?.addEventListener("wheel", update, { passive: true });
    canvasEl?.addEventListener("mousemove", update, { passive: true });
    
    // 2. requestAnimationFrame å¾ªç¯
    let lastScale = 0, lastOffsetX = 0, lastOffsetY = 0;
    const loop = () => {
        if (!this.container) return;
        const ds = app.canvas?.ds;
        if (ds && (ds.scale !== lastScale || 
                   ds.offset[0] !== lastOffsetX || 
                   ds.offset[1] !== lastOffsetY)) {
            lastScale = ds.scale;
            lastOffsetX = ds.offset[0];
            lastOffsetY = ds.offset[1];
            update();
        }
        requestAnimationFrame(loop);
    };
    requestAnimationFrame(loop);
}
```

#### 7.19.7 Widget å‘ç°ä¸åŒæ­¥

åŠ¨æ€å‚æ•°é€šè¿‡ `api_name` æ¨¡å¼åŒ¹é…å®šä½ï¼š

```javascript
findDynamicWidget(apiNamePattern) {
    return this.node._dynamicParamManager?.dynamicWidgets?.find(
        w => w._paramDef?.api_name?.toLowerCase().includes(apiNamePattern)
    );
}

// å¾ªç¯åˆ‡æ¢å€¼
onStyleClick() {
    const widget = this.findDynamicWidget("style");
    if (widget?.options?.values) {
        const values = widget.options.values;
        const currentIdx = values.indexOf(widget.value);
        const nextIdx = (currentIdx + 1) % values.length;
        widget.value = values[nextIdx];
        this.updateButtonLabels();
    }
}
```

#### 7.19.8 å›¾ç‰‡ç›‘å¬å™¨

è½®è¯¢èŠ‚ç‚¹çš„å›¾ç‰‡å±æ€§å¹¶æ›´æ–°é¢„è§ˆï¼š

```javascript
startImageWatcher() {
    this._imageWatcher = setInterval(() => {
        this.updateImagePreview();
    }, 500);
}

updateImagePreview() {
    // å‘ç°æ ˆï¼šæ£€æŸ¥å¤šä¸ªå¯èƒ½çš„å›¾ç‰‡å±æ€§
    const images = this.node._cachedImages || 
                   this.node._previewImages ||
                   this.node.imgs ||
                   this.node.images;
    
    if (images?.length > 0) {
        const selectedIdx = this.node._selectedImageIndex || 0;
        const image = images[selectedIdx];
        
        // è§£æ URLï¼ˆæ”¯æŒå­—ç¬¦ä¸²ã€HTMLImageElementã€metadata å¯¹è±¡ï¼‰
        let url = typeof image === "string" ? image :
                  image.src || image.url ||
                  `/view?filename=${image.filename}&type=temp`;
        
        if (url && this.previewImg.src !== url) {
            this.previewImg.src = url;
            this.placeholder.style.display = "none";
            this.previewImg.style.display = "block";
        }
    }
}
```

#### 7.19.9 åˆå§‹åŒ–æµç¨‹

```javascript
// dynamic_params.js ä¸­åˆå§‹åŒ–
import { NodeOverlay } from "./image_panel.js";

app.registerExtension({
    name: "Comfy.Custom.DynamicParams",
    async nodeCreated(node) {
        if (isBatchboxNode(node)) {
            // éšè—åŸç”Ÿ widgets
            node.widgets?.forEach(w => w.element?.style.display = "none");
            
            // åˆ›å»º DOM overlay
            node._overlay = new NodeOverlay(node);
        }
    }
});
```

---

**ä¿®æ”¹çš„æ–‡ä»¶ï¼š**

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `web/image_panel.js` | NodeOverlay ç±»ï¼ˆ~800è¡Œï¼‰ï¼šä¸»é¢˜ã€å®¹å™¨ã€ç»„ä»¶ã€åŒæ­¥ã€äº¤äº’ |
| `web/image_panel.css` | æ ·å¼æ–‡ä»¶ |
| `web/dynamic_params.js` | å¯¼å…¥å¹¶åœ¨ nodeCreated ä¸­åˆå§‹åŒ– overlay |

**å¾…å®ŒæˆåŠŸèƒ½ï¼š**

| åŠŸèƒ½ | çŠ¶æ€ |
|------|------|
| å›¾ç‰‡é¢„è§ˆæ˜¾ç¤º | ğŸŸ¡ watcher å·²å®ç°ï¼Œå¾…è°ƒè¯• |
| ç¼©ç•¥å›¾ç”»å»Š | âšª æœªå¼€å§‹ |
| ç”ŸæˆæŒ‰é’® loading åŠ¨ç”» | âšª æœªå¼€å§‹ |
| Canvas ç¼©æ”¾æŠ–åŠ¨ä¼˜åŒ– | ğŸŸ¡ åŸºæœ¬å®ç° |

## 8. ç»´æŠ¤æŒ‡å—



### 8.1 æ·»åŠ æ–° API

1. è·å–ç¬¬ä¸‰æ–¹ API æ–‡æ¡£
2. å°† `YAML_CONFIG_REFERENCE.md` + API æ–‡æ¡£å‘ç»™ LLM
3. è¯·æ±‚ LLM ç”Ÿæˆ YAML é…ç½®
4. åœ¨ API Manager ä¸­æµ‹è¯•

### 8.2 å¸¸è§é—®é¢˜

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|----------|
| å‚æ•°ä¸æ˜¾ç¤º | æ£€æŸ¥ `parameter_schema` æ ¼å¼ |
| å›¾ç‰‡ä¸å‘é€ | æ£€æŸ¥ `file_format` é…ç½® |
| ç«¯ç‚¹ä¸åˆ‡æ¢ | æ£€æŸ¥ `priority` è®¾ç½® |

---

## 9. æ›´æ–°æ—¥å¿—

### v2.22 (2026-01-30) - å®éªŒæ€§åˆ†æ”¯

- ğŸ§ª DOM Overlay UIï¼šåŸºäº DOM çš„ç°ä»£åŒ–èŠ‚ç‚¹ç•Œé¢ï¼ˆ`feature/dom-overlay-ui` åˆ†æ”¯ï¼‰
- âšª æ–°å¢ `image_panel.js` + `image_panel.css`ï¼šNodeOverlay ç±»å®ç°
- âšª 7 ä¸ªå·¥å…·æ æŒ‰é’®ï¼šModel/Style/Resolution/Ratio/Batch/More/Generate
- âšª å›¾ç‰‡é¢„è§ˆåŒº + æç¤ºè¯è¾“å…¥æ¡† + é«˜çº§è®¾ç½®é¢æ¿
- âš ï¸ å¾…å®Œæˆï¼šå›¾ç‰‡é¢„è§ˆæ˜¾ç¤ºã€Canvas ç¼©æ”¾åŒæ­¥ä¼˜åŒ–

### v2.21 (2026-01-29)

- âœ… åŠ¨æ€ç¼“å­˜åŠ è½½ï¼šæ ¹æ® `all_images` è¾“å‡ºç«¯å£è¿æ¥çŠ¶æ€å†³å®šåŠ è½½ç­–ç•¥
- âœ… æœªè¿æ¥æ—¶åªåŠ è½½é€‰ä¸­çš„ 1 å¼ å›¾ç‰‡ï¼ˆ~195MBï¼‰ï¼Œè¿æ¥æ—¶åŠ è½½å…¨éƒ¨
- âœ… å‰ç«¯æ£€æµ‹ `node.outputs[1].links` ä¼ é€’ç»™åç«¯
- âš™ï¸ æŠ€æœ¯ï¼š`_all_images_connected` hidden input + `load_all` å‚æ•°

### v2.20 (2026-01-29)

- âœ… å…±äº«å›¾ç‰‡æ•°æ®ä¼˜åŒ–ï¼šImg2img æ‰¹é‡ç”Ÿæˆæ—¶æ‰€æœ‰è¯·æ±‚å…±äº«åŒä¸€ä»½ base64 æ•°æ®
- âœ… ä¸€æ¬¡ç¼–è§£ç ï¼šé¢„å¤„ç†é˜¶æ®µç¼“å­˜ bytes + base64ï¼Œé¿å…é‡å¤ç¼–è§£ç 
- âœ… å†…å­˜å ç”¨ä» NÃ—ImageSize é™åˆ° ~1Ã—ImageSize
- ğŸ”§ fix: multipart è¯·æ±‚å…¼å®¹ - 4 å…ƒç»„æˆªå–å‰ 3 å…ƒç´ ç»™ `requests` åº“
- âš™ï¸ æŠ€æœ¯ï¼š4 å…ƒç»„ `(filename, bytes, mime, cached_b64)` + å…¨éƒ¨æ‰¹æ¬¡å¹¶è¡Œ

### v2.19 (2026-01-29)

- âœ… ä¿®å¤ `HTTPRequestEntityTooLarge` é”™è¯¯ï¼šå¤§è¯·æ±‚ä½“ï¼ˆå¦‚ base64 å›¾ç‰‡ï¼‰ä¸å†å¤±è´¥
- âœ… ä½¿ç”¨åˆ†å—è¿­ä»£è¯»å– `request.content.iter_any()` ç¡®ä¿å®Œæ•´æ¥æ”¶
- âœ… ç§»é™¤è¯·æ±‚ä½“å¤§å°é™åˆ¶ï¼Œæ”¯æŒä»»æ„å¤§å°çš„ base64 å›¾ç‰‡
- ğŸ”§ fix: JSON è§£æé”™è¯¯ï¼ˆUnterminated stringï¼‰- ç¡®ä¿å®Œæ•´è¯»å–åå†è§£æ

### v2.18 (2026-01-29)

- âœ… æ‰¹é‡å›¾ç‰‡å°ºå¯¸å½’ä¸€åŒ–ï¼šAPI è¿”å›ä¸åŒå°ºå¯¸å›¾ç‰‡æ—¶è‡ªåŠ¨ä»¥æœ€å¤§å°ºå¯¸ä¸ºç›®æ ‡ç¼©æ”¾
- âœ… ä¿å­˜æ–‡ä»¶ä¿ç•™åŸå§‹å°ºå¯¸ï¼Œå½’ä¸€åŒ–ä»…å½±å“ tensor è¾“å‡º
- âœ… ä½¿ç”¨ LANCZOS é«˜è´¨é‡ç¼©æ”¾ç®—æ³•
- ğŸ“ å·²è®°å½•åˆ° Knowledge Base roadmapï¼šè‡ªå®šä¹‰æ‰¹é‡å›¾ç‰‡ç±»å‹è§„åˆ’

### v2.17 (2026-01-28)

- âœ… é€‰ä¸­å›¾ç‰‡æ”¾å¤§æ˜¾ç¤ºï¼šç”Ÿæˆå¤šå¼ å›¾åé»˜è®¤ç¬¬ä¸€å¼ æ”¾å¤§å‘ˆç°å¹¶è¾“å‡ºç»™ä¸‹æ¸¸
- âœ… ç¼©ç•¥å›¾åˆ‡æ¢ï¼šç‚¹å‡» X å›åˆ°ç¼©ç•¥å›¾æ¨¡å¼ï¼Œç‚¹å‡»ä»»æ„ç¼©ç•¥å›¾é‡æ–°æ”¾å¤§
- âœ… æ‰§è¡Œåä¿æŒæ”¾å¤§ï¼šQueue Prompt åé€‰ä¸­å›¾ç‰‡ä¾æ—§æ”¾å¤§ï¼Œä¸é—ªå›ç¼©ç•¥å›¾
- âœ… é‡å¯æ¢å¤ï¼šè¢«é€‰å›¾ç‰‡ä¿¡æ¯æŒä¹…åŒ–ï¼Œé‡å¯åä¾æ—§æ”¾å¤§æ˜¾ç¤º
- âš™ï¸ æŠ€æœ¯ï¼šProperty Interception + 100ms Execution Window Guard
- ğŸ”§ fix: å¹¶å‘ç”Ÿæˆæ—¶é¢„è§ˆå´©æºƒ - `updateNodePreview` ä¸­ä½¿ç”¨ä¸´æ—¶æ•°ç»„é¿å…æš´éœ² null å…ƒç´ 

### v2.16 (2026-01-28)
- âœ… æ™ºèƒ½ç¼“å­˜ï¼šèŠ‚ç‚¹ä½œä¸ºå›¾ç‰‡æ¥æºï¼Œå·²ç”Ÿæˆå›¾ç‰‡å Queue Prompt ä¸å†è°ƒç”¨ API
- âœ… ç»Ÿä¸€åç«¯å“ˆå¸Œï¼šç‹¬ç«‹ç”Ÿæˆå’Œ Queue Prompt ç¼“å­˜çŠ¶æ€ååŒ
- âœ… æ–°å¢"å‚æ•°å˜åŒ–æ£€æµ‹"å¼€å…³ï¼ˆAPI Manager â†’ èŠ‚ç‚¹æ˜¾ç¤ºè®¾ç½®ï¼‰
- âœ… ä¿®å¤è·¨å¹³å° JSON åºåˆ—åŒ–å·®å¼‚

### v2.15 (2026-01-27)
- âœ… å³æ—¶ä¿å­˜ï¼šæ¯å¼ å›¾ç‰‡æ”¶åˆ°åç«‹å³å†™å…¥ç£ç›˜ï¼Œé˜²æ­¢æ–­ç”µä¸¢å¤±
- âœ… Gemini API æ ¼å¼ä¿®å¤ï¼š`imageSize`/`aspectRatio` æ”¾å…¥ `imageConfig` åµŒå¥—å¯¹è±¡
- âœ… çº¿ç¨‹å®‰å…¨ä¼˜åŒ–ï¼šé¢„åˆå§‹åŒ– SaveSettings å®ä¾‹

### v2.14 (2026-01-27)
- âœ… åŠ¨æ€è¾“å…¥æ§½ç´§å‡‘ï¼šæ–­å¼€ä¸­é—´æ§½ä½åï¼Œè¿æ¥è‡ªåŠ¨å‘å‰ç§»åŠ¨
- âœ… å¹¶è¡Œæ‰¹å¤„ç†ï¼šæ‰¹é‡ç”Ÿæˆä»ä¸²è¡Œæ”¹ä¸ºå¹¶è¡Œï¼Œæ•ˆç‡æå‡ 4x+
- âœ… æ¨¡å‹è¿ç§»ï¼šæ–°å¢ DALL-E-3ã€GPT-4o-Imageã€Sora-Imageã€Flux ç³»åˆ—ã€Midjourneyã€Luma Video

### v2.13 (2026-01-27)
- âœ… ç”»å¸ƒå³é”®èœå•å¿«æ·æ·»åŠ åŠŸèƒ½
- âœ… å¯åœ¨ API Manager â†’ èŠ‚ç‚¹æ˜¾ç¤ºè®¾ç½® ä¸­å¼€å…³
- âœ… ä½¿ç”¨ `getCanvasMenuItems()` å®˜æ–¹ hook
- âœ… çƒ­é‡è½½æ”¯æŒï¼ˆæ— éœ€åˆ·æ–°é¡µé¢ï¼‰

### v2.12 (2026-01-27)
- âœ… åŠ¨æ€å‚æ•°æŒä¹…åŒ–ä¿®å¤ï¼šé£æ ¼ã€åˆ†è¾¨ç‡ã€æ¯”ä¾‹ç­‰å‚æ•°æ­£ç¡®æ¢å¤
- âœ… Endpoint é€‰æ‹©å™¨çŠ¶æ€æŒä¹…åŒ–
- âœ… é«˜çº§è®¾ç½®æŠ˜å /å±•å¼€çŠ¶æ€æŒä¹…åŒ–
- âœ… é‡‡ç”¨ "Pending State" æ¨¡å¼æ¶ˆé™¤ UI é—ªçƒ
- âœ… ä¿®å¤ api_name vs widget.name key ä¸åŒ¹é…é—®é¢˜

### v2.11 (2026-01-27)
- âœ… é…ç½®çƒ­é‡è½½ï¼šä¿å­˜ API Manager è®¾ç½®åç”»å¸ƒèŠ‚ç‚¹ç«‹å³åˆ·æ–°
- âœ… æ¨¡å‹ä¸‹æ‹‰åˆ—è¡¨å®æ—¶æ›´æ–°ï¼ˆæ— éœ€åˆ·æ–°æµè§ˆå™¨ï¼‰
- âœ… `batchbox:config-changed` äº‹ä»¶é€šçŸ¥æœºåˆ¶
- âœ… ä» `/api/batchbox/models` è·å–æœ€æ–°æ¨¡å‹åˆ—è¡¨æ›´æ–° widget options
- âœ… `onModelChange()` æ”¯æŒ `forceRefresh` å‚æ•°

### v2.10 (2026-01-27)
- âœ… "å¼€å§‹ç”Ÿæˆ"æŒ‰é’®æ‰©å±•è‡³æ‰€æœ‰ BatchBox èŠ‚ç‚¹ç±»å‹
- âœ… DynamicVideoã€DynamicTextã€DynamicAudio èŠ‚ç‚¹ç°æ”¯æŒç‹¬ç«‹ç”Ÿæˆ
- âœ… ä½¿ç”¨ç»Ÿä¸€çš„èŠ‚ç‚¹åŒ¹é…æ¨¡å¼åˆ—è¡¨æ›¿ä»£ç¡¬ç¼–ç æ¡ä»¶

### v2.9 (2026-01-27)
- âœ… ç‹¬ç«‹ç”Ÿæˆæ—¥å¿—ä¼˜åŒ–ï¼ˆç§»é™¤å†—ä½™ base64 è¾“å‡ºï¼‰
- âœ… ä¿®å¤äº‹ä»¶å¾ªç¯é˜»å¡é—®é¢˜ï¼ˆä½¿ç”¨ asyncio.to_threadï¼‰
- âœ… å›¾ç‰‡å®æ—¶æ˜¾ç¤ºä¼˜åŒ–ï¼ˆonload å›è°ƒè§¦å‘é‡ç»˜ï¼‰
- âœ… é‡å¯åå›¾ç‰‡æ¢å¤ï¼ˆå¤„ç†å¤šç§ _last_images æ ¼å¼ï¼‰
- âš ï¸ å¸ƒå±€è·³åŠ¨é—®é¢˜éƒ¨åˆ†ç¼“è§£ï¼ˆ_isRestoring æŠ‘åˆ¶æœºåˆ¶ï¼‰

### v2.8 (2026-01-26)
- âœ… Queue Prompt æ‹¦æˆªå¼€å…³
- âœ… BatchBox èŠ‚ç‚¹å¯é€‰æ‹©ä»…é€šè¿‡"å¼€å§‹ç”Ÿæˆ"æŒ‰é’®è§¦å‘
- âœ… å…¨å±€ Queue Prompt è‡ªåŠ¨æ’é™¤ BatchBox èŠ‚ç‚¹ï¼ˆå¯é…ç½®ï¼‰
- âœ… API Manager â†’ èŠ‚ç‚¹æ˜¾ç¤ºè®¾ç½® â†’ æ‹¦æˆªå¼€å…³ UI
- âœ… è®¾ç½®åŒæ­¥æœºåˆ¶ä¿®å¤ï¼ˆé˜²æ­¢ä¸»ä¿å­˜æŒ‰é’®è¦†ç›–ï¼‰
- âœ… è®¾ç½®å®æ—¶ç”Ÿæ•ˆï¼ˆæ— éœ€åˆ·æ–°é¡µé¢ï¼‰

### v2.7 (2026-01-26)
- âœ… "å¼€å§‹ç”Ÿæˆ"æŒ‰é’®éƒ¨åˆ†æ‰§è¡Œæ”¯æŒ
- âœ… `recursiveAddNodes()` é€’å½’æ”¶é›†ä¸Šæ¸¸ä¾èµ–èŠ‚ç‚¹
- âœ… `executeToNode()` ä¸´æ—¶è¦†ç›– `api.queuePrompt` è¿‡æ»¤ `prompt.output`
- âœ… åªæ‰§è¡Œç›®æ ‡èŠ‚ç‚¹åŠå…¶ä¸Šæ¸¸ä¾èµ–ï¼Œè·³è¿‡ä¸ç›¸å…³åˆ†æ”¯

### v2.6 (2026-01-26)
- âœ… Gemini åŸç”Ÿ API æ ¼å¼æ”¯æŒ (`/v1beta/models/{model}:generateContent`)
- âœ… `responseModalities: ['Image']` å¼ºåˆ¶åªè¿”å›å›¾ç‰‡
- âœ… Gemini å“åº”è§£æï¼ˆinlineData base64 å›¾ç‰‡æå–ï¼‰
- âœ… Prompt å‰ç¼€åŠŸèƒ½ï¼ˆè‡ªåŠ¨æ·»åŠ  "ç”Ÿæˆä¸€å¼ å›¾ç‰‡ï¼š" ç­‰å‰ç¼€ï¼‰
- âœ… API Manager ç«¯ç‚¹è®¾ç½®æ·»åŠ  API æ ¼å¼é€‰æ‹©å™¨
- âœ… API Manager ç«¯ç‚¹è®¾ç½®æ·»åŠ  Prompt å‰ç¼€è¾“å…¥æ¡†

### v2.5.1 (2026-01-25)
- âœ… èŠ‚ç‚¹é»˜è®¤å®½åº¦å¯é…ç½®ï¼ˆ300-1200pxï¼‰
- âœ… API Manager â†’ ä¿å­˜è®¾ç½® Tab æ·»åŠ å®½åº¦æ»‘å—
- âœ… `getNodeSettings()` ä»åç«¯è·å–é…ç½®
- âœ… `/api/batchbox/node-settings` API ç«¯ç‚¹
- âœ… `config_manager.py` æ–°å¢ `get/update_node_settings`

### v2.5 (2026-01-25)
- âœ… èŠ‚ç‚¹å®½åº¦ä¿æŒæœºåˆ¶ï¼ˆé˜²æ­¢ 252px é‡ç½®ï¼‰
- âœ… `resizeNodePreservingWidth()` è¾…åŠ©å‡½æ•°
- âœ… æ–°å»º/åŠ è½½èŠ‚ç‚¹ç”Ÿå‘½å‘¨æœŸåŒºåˆ†
- âœ… åˆ‡æ¢æ¨¡å‹åå®½åº¦ä¸ä¸¢å¤±
- âœ… å·¥ä½œæµä¿å­˜/åŠ è½½å®½åº¦æ­£ç¡®æ¢å¤

### v2.4 (2026-01-25)
- âœ… èŠ‚ç‚¹é¢„è§ˆæŒä¹…åŒ–ï¼ˆé‡å¯åä¸ä¸¢å¤±ï¼‰

### v2.3 (2026-01-25)
- âœ… æ¨¡å‹æ’åºåŠŸèƒ½ï¼ˆmodel_order é…ç½®ï¼‰
- âœ… æ‹–æ‹½æ’åº UIï¼ˆHTML5 Drag & Dropï¼‰
- âœ… èŠ‚ç‚¹ä¸‹æ‹‰æ¡†æŒ‰é…ç½®é¡ºåºæ˜¾ç¤º
- âœ… ConfigManager æ–°å¢ get/set_model_order æ–¹æ³•

### v2.2 (2026-01-25)
- âœ… è‡ªåŠ¨ä¿å­˜åŠŸèƒ½ï¼ˆsave_settings.pyï¼‰
- âœ… å¯é…ç½®ä¿å­˜ç›®å½•ã€æ ¼å¼ã€å‘½åæ¨¡å¼
- âœ… â€œä¿æŒåŸæ ¼å¼â€é€‰é¡¹ + é»˜è®¤æ ¼å¼è®¾ç½®
- âœ… API Manager ä¸­æ–°å¢â€œä¿å­˜è®¾ç½®â€ Tab
- âœ… æ–‡ä»¶åå®æ—¶é¢„è§ˆ
- âœ… æŒ‰æ—¥æœŸåˆ›å»ºå­æ–‡ä»¶å¤¹

### v2.1 (2026-01-25)
- âœ… è¯·æ±‚æ—¥å¿—ç³»ç»Ÿï¼ˆå¯é…ç½®çº§åˆ«ï¼‰
- âœ… è¯·æ±‚é‡è¯•æœºåˆ¶ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
- âœ… ç»“æ„åŒ–å¼‚å¸¸ç±»
- âœ… é…ç½®éªŒè¯
- âœ… åç«¯/å‰ç«¯ TTL ç¼“å­˜
- âœ… é…ç½®çƒ­æ›´æ–°
- âœ… RGBA é€æ˜åº¦ä¿æŒ
- âœ… WebP æ ¼å¼æ”¯æŒ
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–

### v2.0 (2026-01-24)
- âœ… æ‰‹åŠ¨ç«¯ç‚¹é€‰æ‹©
- âœ… è½®è¯¢æ¨¡å¼
- âœ… å±‚çº§æ–‡ä»¶æ ¼å¼é…ç½®
- âœ… åŠ¨æ€è¾“å…¥æ§½ä¿®å¤
- âœ… LLM é…ç½®å‚è€ƒæ–‡æ¡£

### v1.0 (åˆç‰ˆ)
- åŠ¨æ€å‚æ•°ç³»ç»Ÿ
- å¤šä¾›åº”å•†æ”¯æŒ
- åŸºç¡€ API é€‚é…å™¨
