# ComfyUI-Custom-Batchbox

**ComfyUI-Custom-Batchbox** æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ ComfyUI è‡ªå®šä¹‰èŠ‚ç‚¹ç³»ç»Ÿï¼Œæ”¯æŒåŠ¨æ€å‚æ•°é¢æ¿ã€å¤š API ä¾›åº”å•†ã€è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œä»¥åŠå®Œæ•´çš„å¯è§†åŒ–é…ç½®ç®¡ç†ã€‚

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

### ğŸ¯ åŠ¨æ€å‚æ•°é¢æ¿

- é€‰æ‹©ä¸åŒæ¨¡å‹åï¼ŒèŠ‚ç‚¹å‚æ•°è‡ªåŠ¨æ›´æ–°
- æ”¯æŒå‚æ•°åˆ†ç»„ï¼ˆåŸºç¡€/é«˜çº§ï¼‰
- æ”¯æŒå¤šç§å‚æ•°ç±»å‹ï¼šå­—ç¬¦ä¸²ã€æ•°å­—ã€ä¸‹æ‹‰é€‰æ‹©ã€å¼€å…³

### ğŸ”Œ å¤šä¾›åº”å•†æ”¯æŒ

- åŒä¸€æ¨¡å‹å¯é…ç½®å¤šä¸ª API ä¾›åº”å•†
- æ”¯æŒä¼˜å…ˆçº§æ’åº
- è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼ˆFailoverï¼‰

### ğŸ“Š èŠ‚ç‚¹ç±»å‹

| èŠ‚ç‚¹ | åŠŸèƒ½ |
|------|------|
| ï¿½ï¸ å›¾ç‰‡ç”Ÿæˆ | æ–‡ç”Ÿå›¾ã€å›¾ç”Ÿå›¾ |
| ğŸ“ æ–‡æœ¬ç”Ÿæˆ | AI è„šæœ¬ã€å¹¿å‘Šè¯ |
| ğŸ¬ è§†é¢‘ç”Ÿæˆ | AI è§†é¢‘åˆ›ä½œ |
| ğŸµ éŸ³é¢‘ç”Ÿæˆ | AI éŸ³é¢‘åˆæˆ |
| ï¿½ å›¾ç‰‡ç¼–è¾‘ | å±€éƒ¨é‡ç»˜ã€è¶…åˆ† |

### âš™ï¸ å¯è§†åŒ–é…ç½®

- å†…ç½® API Manager ç•Œé¢
- æ— éœ€ç¼–è¾‘ YAML æ–‡ä»¶
- æ”¯æŒçƒ­æ›´æ–°

### ğŸ›¡ï¸ ç¨‹åºå¼ºå¥æ€§

- è¯·æ±‚é‡è¯•æœºåˆ¶ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
- ç»“æ„åŒ–å¼‚å¸¸å¤„ç†
- å¯é…ç½®æ—¥å¿—çº§åˆ«
- RGBA é€æ˜åº¦ä¿æŒ
- WebP æ ¼å¼æ”¯æŒ

### ğŸ’¾ è‡ªåŠ¨ä¿å­˜åŠŸèƒ½

- ç”Ÿæˆå›¾ç‰‡è‡ªåŠ¨ä¿å­˜åˆ°æŒ‡å®šç›®å½•
- å¯è‡ªå®šä¹‰å‘½åæ ¼å¼ï¼ˆæ¨¡å‹åã€æ—¶é—´æˆ³ã€seed ç­‰ï¼‰
- æ”¯æŒ PNG/JPG/WebP æˆ–ä¿æŒåŸæ ¼å¼
- æŒ‰æ—¥æœŸè‡ªåŠ¨åˆ›å»ºå­æ–‡ä»¶å¤¹
- API Manager å†…å¯è§†åŒ–é…ç½®

### ğŸ”„ é¢„è§ˆæŒä¹…åŒ–

- é‡å¯ ComfyUI åé¢„è§ˆå›¾ç‰‡ä¸ä¸¢å¤±
- è‡ªåŠ¨ä»ä¿å­˜çš„æ–‡ä»¶æ¢å¤é¢„è§ˆ
- è¯¦è§ [docs/preview_persistence.md](docs/preview_persistence.md)

### ğŸ“Š æ¨¡å‹æ’åº

- æ‹–æ‹½è°ƒæ•´æ¨¡å‹æ˜¾ç¤ºé¡ºåº
- èŠ‚ç‚¹ä¸‹æ‹‰æ¡†æŒ‰é…ç½®é¡ºåºæ˜¾ç¤º
- é¡ºåºä¿å­˜åœ¨ `api_config.yaml`

### ğŸ“ èŠ‚ç‚¹å®½åº¦ä¿æŒ

- **å¯é…ç½®é»˜è®¤å®½åº¦** - åœ¨ API Manager â†’ ä¿å­˜è®¾ç½® Tab ä¸­è°ƒæ•´ï¼ˆ300-1200pxï¼‰
- æ–°å»ºèŠ‚ç‚¹ä½¿ç”¨é…ç½®çš„é»˜è®¤å®½åº¦
- åˆ‡æ¢æ¨¡å‹åä¿æŒç”¨æˆ·è®¾ç½®çš„å®½åº¦
- ä¿å­˜/åŠ è½½å·¥ä½œæµåå®½åº¦æ­£ç¡®æ¢å¤
- è¯¦è§ [docs/node_width_retrospective.md](docs/node_width_retrospective.md)

### ğŸŒ å¤š API æ ¼å¼æ”¯æŒ

- **OpenAI å…¼å®¹æ ¼å¼** - æ ‡å‡† `/v1/chat/completions` ç«¯ç‚¹
- **Gemini åŸç”Ÿæ ¼å¼** - æ”¯æŒ `/v1beta/models/{model}:generateContent`
  - æ”¯æŒ `responseModalities: ['Image']` å¼ºåˆ¶åªè¿”å›å›¾ç‰‡
  - è‡ªåŠ¨è§£æ Gemini å“åº”ä¸­çš„ base64 å›¾ç‰‡
- åœ¨ API Manager ç«¯ç‚¹é«˜çº§è®¾ç½®ä¸­åˆ‡æ¢ API æ ¼å¼

### âœï¸ Prompt å‰ç¼€

- ä¸ºç«¯ç‚¹é…ç½®è‡ªåŠ¨ prompt å‰ç¼€ï¼ˆå¦‚ `ç”Ÿæˆä¸€å¼ å›¾ç‰‡ï¼š`ï¼‰
- ç”¨æˆ·è¾“å…¥ `å“ˆå“ˆå“ˆ` â†’ å®é™…å‘é€ `ç”Ÿæˆä¸€å¼ å›¾ç‰‡ï¼šå“ˆå“ˆå“ˆ`
- ç”¨äºå¼ºåˆ¶æ¨¡å‹ç”Ÿæˆå›¾ç‰‡è€Œéæ–‡æœ¬å›å¤
- åœ¨ API Manager ç«¯ç‚¹é«˜çº§è®¾ç½®ä¸­é…ç½®

---

## ğŸš€ å®‰è£…

1. å°†æœ¬é¡¹ç›®æ”¾å…¥ ComfyUI `custom_nodes` ç›®å½•ï¼š

   ```
   ComfyUI/custom_nodes/ComfyUI-Custom-Batchbox/
   ```

2. å®‰è£…ä¾èµ–ï¼š

   ```bash
   pip install pyyaml requests
   ```

3. **é‡å¯ ComfyUI**

---

## âš™ï¸ é…ç½®æŒ‡å—

### æ–¹å¼ä¸€ï¼šå¯è§†åŒ–é…ç½®ï¼ˆæ¨èï¼‰

1. åœ¨ ComfyUI èœå•ä¸­æ‰¾åˆ° **Batchbox API Manager**
2. é…ç½®ä¾›åº”å•†ï¼š
   - åç§°ï¼ˆå¦‚ `bltcy_ai`ï¼‰
   - Base URLï¼ˆå¦‚ `https://api.bltcy.ai`ï¼‰
   - API Key
3. é…ç½®æ¨¡å‹ï¼š
   - é€‰æ‹©ç±»åˆ«ï¼ˆå›¾ç‰‡/æ–‡æœ¬/è§†é¢‘ç­‰ï¼‰
   - è®¾ç½®å‚æ•° Schema
   - é…ç½® API ç«¯ç‚¹

### æ–¹å¼äºŒï¼šYAML é…ç½®

ç¼–è¾‘ `api_config.yaml`ï¼š

```yaml
# 1. ä¾›åº”å•†é…ç½®
providers:
  bltcy_ai:
    base_url: "https://api.bltcy.ai"
    api_key: "sk-xxxxxxxx"

# 2. æ¨¡å‹é…ç½®
models:
  banana_pro:
    display_name: "ğŸŒ Banana Pro"
    category: image
    parameter_schema:
      basic:
        prompt: { type: string, default: "" }
        style: 
          type: select
          default: realistic
          options:
            - { value: realistic, label: å†™å®é£æ ¼ }
            - { value: anime, label: åŠ¨æ¼«é£æ ¼ }
    api_endpoints:
      - provider: bltcy_ai
        priority: 1
        modes:
          text2img:
            endpoint: "/v1/images/generations"
          img2img:
            endpoint: "/v1/images/edits"

# 3. å…¨å±€è®¾ç½®
settings:
  default_timeout: 600
  max_retries: 3
  auto_failover: true
```

---

## ğŸ“– ä½¿ç”¨è¯´æ˜

### 1. æ·»åŠ èŠ‚ç‚¹

åœ¨ ComfyUI ä¸­æœç´¢ `ComfyUI-Custom-Batchbox`ï¼Œé€‰æ‹©å¯¹åº”ç±»å‹çš„èŠ‚ç‚¹ã€‚

### 2. é€‰æ‹©æ¨¡å‹

ä»ä¸‹æ‹‰èœå•é€‰æ‹©å·²é…ç½®çš„æ¨¡å‹ï¼Œå‚æ•°é¢æ¿ä¼šè‡ªåŠ¨æ›´æ–°ã€‚

### 3. è¿æ¥è¾“å…¥

- **prompt**: å¿…å¡«ï¼Œæç¤ºè¯
- **image**: å¯é€‰ï¼Œç”¨äºå›¾ç”Ÿå›¾

### 4. æ‰§è¡Œ

è¿æ¥è¾“å‡ºåæ‰§è¡Œå·¥ä½œæµã€‚

---

## ğŸ”§ ç«¯ç‚¹é…ç½®è¯´æ˜

### text2img vs img2img

æ¯ä¸ªæ¨¡å‹å¯é…ç½®ä¸¤ç§ç«¯ç‚¹ï¼š

| ç«¯ç‚¹ | ç”¨é€” | è§¦å‘æ¡ä»¶ |
|------|------|----------|
| text2img | æ–‡ç”Ÿå›¾ | æ— å›¾ç‰‡è¾“å…¥ |
| img2img | å›¾ç”Ÿå›¾ | æœ‰å›¾ç‰‡è¾“å…¥ |

**é…ç½®è§„åˆ™ï¼š**

- è‡³å°‘é…ç½®ä¸€ä¸ªç«¯ç‚¹
- å¦‚åªé…ç½®ä¸€ä¸ªï¼Œå¦ä¸€ä¸ªè‡ªåŠ¨ä½¿ç”¨ç›¸åŒç«¯ç‚¹

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
ComfyUI-Custom-Batchbox/
â”œâ”€â”€ __init__.py          # å…¥å£ã€API ç«¯ç‚¹æ³¨å†Œ
â”œâ”€â”€ nodes.py             # èŠ‚ç‚¹å®šä¹‰
â”œâ”€â”€ config_manager.py    # é…ç½®ç®¡ç†å™¨ï¼ˆå«ç¼“å­˜ã€éªŒè¯ï¼‰
â”œâ”€â”€ batchbox_logger.py   # æ—¥å¿—ä¸é‡è¯•æ¨¡å—
â”œâ”€â”€ errors.py            # ç»“æ„åŒ–å¼‚å¸¸ç±»
â”œâ”€â”€ image_utils.py       # å›¾ç‰‡å¤„ç†å·¥å…·
â”œâ”€â”€ api_config.yaml      # é…ç½®æ–‡ä»¶
â”œâ”€â”€ adapters/            # API é€‚é…å™¨
â”‚   â”œâ”€â”€ base.py
â”‚   â”œâ”€â”€ generic.py       # é€šç”¨é€‚é…å™¨ï¼ˆå±‚çº§é…ç½® + é‡è¯•ï¼‰
â”‚   â””â”€â”€ template_engine.py
â”œâ”€â”€ web/                 # å‰ç«¯èµ„æº
â”‚   â”œâ”€â”€ api_manager.js
â”‚   â”œâ”€â”€ api_manager.css
â”‚   â”œâ”€â”€ dynamic_params.js
â”‚   â””â”€â”€ dynamic_inputs.js
â”œâ”€â”€ tests/               # å•å…ƒæµ‹è¯•
â””â”€â”€ docs/                # æ–‡æ¡£
```

---

## â“ å¸¸è§é—®é¢˜

### Q: èŠ‚ç‚¹åŠ è½½å¤±è´¥ï¼Ÿ

**A:** æ£€æŸ¥ä¾èµ–æ˜¯å¦å®‰è£…ï¼š

```bash
pip install pyyaml requests
```

### Q: è‡ªåŠ¨åˆ‡æ¢ä¾›åº”å•†ä¸ç”Ÿæ•ˆï¼Ÿ

**A:** ç¡®ä¿ï¼š

1. é…ç½®äº†å¤šä¸ªä¾›åº”å•†
2. `settings.auto_failover` è®¾ä¸º `true`
3. å„ç«¯ç‚¹çš„ä¾›åº”å•†ä¼˜å…ˆçº§æ­£ç¡®è®¾ç½®

### Q: API Key ä¸æ˜¾ç¤ºï¼Ÿ

**A:** ç‚¹å‡»è¾“å…¥æ¡†æ—è¾¹çš„ ğŸ‘ æŒ‰é’®å¯ä»¥æ˜¾ç¤º/éšè—ã€‚

---

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ”— ç›¸å…³é“¾æ¥

- [ComfyUI å®˜æ–¹ä»“åº“](https://github.com/comfyanonymous/ComfyUI)
